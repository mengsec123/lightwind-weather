<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>天气预报</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', system-ui, sans-serif;
      color: #fff;
      background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.5s ease;
    }
    
    body.sunny {
      background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
    }
    
    body.cloudy {
      background: linear-gradient(135deg, #7F7FD5 0%, #91EAE4 100%);
    }
    
    body.rainy {
      background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
    }
    
    body.snowy {
      background: linear-gradient(135deg, #83a4d4 0%, #b6fbff 100%);
    }
    
    body.foggy {
      background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%);
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
    }
    
    /* 卡片通用样式 */
    .card {
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      margin-bottom: 15px;
      padding: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
    }
    
    /* 顶部区域 */
    .header {
      padding: 0.8rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .location-display {
      display: flex;
      align-items: center;
    }
    
    .location-icon {
      font-size: 1.4rem;
      opacity: 0.9;
    }
    
    /* 搜索容器 */
    .search-container {
      width: 100%;
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      position: relative;
      z-index: 10; /* 确保搜索区域在最上层 */
    }
    
    .search-bar {
      width: 80%;
      max-width: 300px;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 20px;
      border: none;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #fff;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .search-input:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .search-results {
      position: absolute;
      width: 100%;
      background: rgba(40, 40, 40, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 12px;
      margin-top: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      left: 0;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .search-results.show {
      display: block;
    }
    
    .search-result-item {
      padding: 0.75rem 1rem;
      color: #fff;
      cursor: pointer;
    }
    
    .search-result-item:hover,
    .search-result-item:active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* 主内容区 */
    .main-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1rem;
    }
    
    /* 合并后的城市信息和温度卡片 */
    .city-info-temperature-card {
      text-align: center;
      margin-bottom: 1.5rem;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px 15px;
      width: 100%;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .city-name {
      font-size: 2.2rem;
      font-weight: 400;
      margin-bottom: 0.2rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    
    /* 添加点击提示样式 */
    .city-name:after {
      content: '▼';
      font-size: 0.8rem;
      position: absolute;
      top: 5px;
      right: -20px;
      opacity: 0.8;
    }
    
    .current-date {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }
    
    /* 温度显示 */
    .temperature-display {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0.5rem 0;
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    .current-temp {
      font-size: 6rem;
      font-weight: 200;
      line-height: 1;
      margin-right: 10px;
    }
    
    .weather-icon {
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .weather-description {
      font-size: 1.4rem;
      margin-left: 12px;
      padding-right: 5px;
    }
    
    /* 合并天气详情和温度卡片的样式 */
    .weather-details {
      display: flex;
      justify-content: space-around;
      width: 100%;
      max-width: 500px;
      margin: 10px auto 0;
      padding: 10px 5px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      flex-wrap: nowrap;
    }
    
    .detail-col {
      text-align: center;
      padding: 0 5px;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    
    .detail-label {
      opacity: 0.8;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
    }
    
    .detail-value {
      font-weight: 500;
    }
    
    /* 小时预报区域 - 横向滚动 */
    .hourly-forecast-section {
      width: 100%;
      margin-bottom: 1.5rem;
      position: relative;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .hourly-scroll {
      overflow-x: auto;
      white-space: nowrap;
      padding: 1rem 0;
      -ms-overflow-style: none;
      scrollbar-width: none;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .hourly-scroll::-webkit-scrollbar {
      display: none;
    }
    
    .hourly-items {
      display: inline-flex;
      padding: 0 0.5rem;
    }
    
    .hourly-item {
      text-align: center;
      padding: 0.8rem 0.8rem;
      min-width: 60px;
      border-radius: 12px;
      transition: transform 0.2s ease, background-color 0.2s ease;
      background-color: rgba(255, 255, 255, 0.15);
      margin: 0 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .hourly-item:active {
      transform: scale(0.95);
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .hourly-time {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      opacity: 0.9;
    }
    
    .hourly-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 0.5rem;
      transform-origin: center;
      transition: transform 0.3s ease;
    }
    
    .hourly-item:hover .hourly-icon,
    .hourly-item:active .hourly-icon {
      transform: scale(1.1);
    }
    
    .hourly-temp {
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    /* 天气预报卡片 */
    .forecast-section {
      width: 100%;
      margin-bottom: 1.5rem;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .forecast-card {
      display: flex;
      align-items: center;
      padding: 1rem 0.8rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      transition: background-color 0.2s ease, transform 0.2s ease;
      background-color: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .forecast-card:active {
      background-color: rgba(255, 255, 255, 0.3);
      transform: scale(0.99);
    }
    
    .forecast-day {
      width: 30%;
      font-weight: 500;
    }
    
    .forecast-icon {
      width: 20%;
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .forecast-card:hover .forecast-icon,
    .forecast-card:active .forecast-icon {
      transform: scale(1.2);
    }
    
    .forecast-temp {
      width: 50%;
      text-align: right;
      font-size: 1.1rem;
    }
    
    .max-temp {
      font-weight: 500;
      margin-right: 0.8rem;
    }
    
    .min-temp {
      opacity: 0.8;
    }
    
    /* 加载动画 */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading-container.show {
      opacity: 1;
      visibility: visible;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 天气动画 */
    .weather-animation {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    
    @keyframes rain-drop {
      0% {
        opacity: 0;
        transform: translateY(-100vh);
      }
      10% {
        opacity: 1;
      }
      95% {
        opacity: 0.8;
      }
      100% {
        opacity: 0;
        transform: translateY(100vh);
      }
    }
    
    .rain-drop {
      position: fixed;
      width: 1px;
      height: 15px;
      background-color: rgba(255, 255, 255, 0.6);
      animation: rain-drop linear infinite;
      z-index: -1;
    }
    
    /* 按钮样式 */
    .btn-ios {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-ios:active {
      transform: scale(0.98);
      background-color: rgba(255, 255, 255, 0.25);
    }
    
    /* 天气图标动画 */
    .animated-icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      transform-origin: center;
    }
    
    .sunny-icon {
      animation: sun-pulse 3s infinite alternate;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    }
    
    .rainy-icon {
      animation: rain-shake 1s infinite ease-in-out;
      text-shadow: 0 0 10px rgba(100, 149, 237, 0.7);
    }
    
    .snowy-icon {
      animation: snow-float 3s infinite ease-in-out;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
    }
    
    .cloudy-icon {
      animation: cloud-drift 4s infinite alternate;
      text-shadow: 0 0 8px rgba(169, 169, 169, 0.7);
    }
    
    @keyframes sun-pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.15); }
    }
    
    @keyframes rain-shake {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-1px, 1px); }
      50% { transform: translate(0, 1px); }
      75% { transform: translate(1px, 0); }
      100% { transform: translate(0, 0); }
    }
    
    @keyframes snow-float {
      0% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-3px) rotate(5deg); }
      100% { transform: translateY(0) rotate(0deg); }
    }
    
    @keyframes cloud-drift {
      0% { transform: translateX(-3px); }
      100% { transform: translateX(3px); }
    }
    
    /* 空气质量指数样式 */
    .text-success {
      color: #4caf50;
    }
    
    .text-info {
      color: #2196f3;
    }
    
    .text-warning {
      color: #ff9800;
    }
    
    .text-danger {
      color: #f44336;
    }
  </style>
</head>
<body>
  <!-- 加载动画 -->
  <div class="loading-container" id="loading-container">
    <div class="spinner"></div>
  </div>

  <!-- 天气动画 -->
  <div id="weather-animation-container" class="weather-animation"></div>

  <div class="container">
    <!-- 主内容区 -->
    <main class="main-content">
      <!-- 合并的城市信息、温度和天气详情卡片 -->
      <div class="city-info-temperature-card">
        <!-- 可点击的城市名，用于选择城市 -->
        <h1 id="city-name" class="city-name" style="cursor: pointer;">正在获取...</h1>
        <p id="current-date" class="current-date"></p>
        
        <div class="temperature-display">
          <div class="current-temp"><span id="current-temp">--</span>°</div>
          <div style="display: flex; align-items: center; margin-left: 5px;">
            <div id="weather-icon" class="weather-icon"></div>
            <div id="current-description" class="weather-description">获取中...</div>
          </div>
        </div>
        
        <!-- 将详细信息部分合并到城市温度卡片中 -->
        <div class="weather-details" style="background: none; border: none; box-shadow: none; margin-top: 0.5rem;">
          <div class="detail-col">
            <div class="detail-label">体感温度</div>
            <div class="detail-value"><span id="feels-like">--</span>°</div>
          </div>
          <div class="detail-col">
            <div class="detail-label">湿度</div>
            <div class="detail-value"><span id="humidity">--</span>%</div>
          </div>
          <div class="detail-col">
            <div class="detail-label">风速</div>
            <div class="detail-value"><span id="wind-speed">--</span> km/h</div>
          </div>
          <div class="detail-col">
            <div class="detail-label">空气质量</div>
            <div class="detail-value"><span id="aqi-value">--</span></div>
          </div>
        </div>
      </div>
      
      <!-- 删除原来独立的天气详情卡片 -->
      
      <!-- 小时预报 - 横向滚动 -->
      <section class="hourly-forecast-section">
        <div class="hourly-scroll">
          <div id="hourly-items" class="hourly-items">
            <!-- 动态生成的小时预报 -->
          </div>
        </div>
      </section>
      
      <!-- 七天预报 -->
      <section class="forecast-section">
        <div id="forecast-container">
          <!-- 动态生成的预报卡片 -->
        </div>
      </section>
    </main>
  </div>

  <script>
    // 全局变量
    const elements = {
      loadingContainer: document.getElementById('loading-container'),
      cityName: document.getElementById('city-name'),
      currentDate: document.getElementById('current-date'),
      currentTemp: document.getElementById('current-temp'),
      currentIcon: document.getElementById('weather-icon'),
      currentDescription: document.getElementById('current-description'),
      feelsLike: document.getElementById('feels-like'),
      humidity: document.getElementById('humidity'),
      windSpeed: document.getElementById('wind-speed'),
      aqiValue: document.getElementById('aqi-value'),
      hourlyItems: document.getElementById('hourly-items'),
      forecastContainer: document.getElementById('forecast-container'),
      weatherAnimationContainer: document.getElementById('weather-animation-container')
    };

    // 本地缓存变量
    let cacheName = 'weatherCache';
    let userCity = '';
    let lastUpdate = null;
    let failedAttempts = 0; // 跟踪失败尝试
    let useFallbackAPI = true; // 默认使用备用API
    
    // 天气图标映射
    const weatherIcons = {
      '晴': '☀',
      '多云': '☁️',
      '小雨': '🌧',
      '中雨': '🌧',
      '大雨': '🌧',
      '暴雨': '⛈️',
      '雷阵雨': '⛈️',
      '雪': '❄️',
      '雾': '🌫',
      'clear-day': '☀',
      'clear-night': '🌙',
      'partly-cloudy-day': '☁️',
      'partly-cloudy-night': '🌥',
      'cloudy': '☁️',
      'rain': '🌧',
      'snow': '❄️',
      'wind': '💨',
      'fog': '🌫',
      'thunderstorm': '⛈️'
    };
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      showLoading();
      updateCurrentDate();
      detectEnvironment();
      
      // 获取用户位置并加载天气
      getUserLocation()
        .then(position => {
          if (position) {
            const { latitude, longitude } = position.coords;
            fetchWeatherData(`${longitude},${latitude}`);
          } else {
            // 如果无法获取位置，尝试使用缓存
            initFromCache();
          }
        })
        .catch(error => {
          console.error('位置获取失败:', error);
          initFromCache();
        });
      
      // 添加城市名点击事件 - 用于选择城市
      if (elements.cityName) {
        elements.cityName.addEventListener('click', () => {
          showCitySelector();
        });
      }
      
      // 注册离线事件处理
      window.addEventListener('offline', () => {
        console.log('网络已断开');
        showOfflineNotice();
      });
      
      window.addEventListener('online', () => {
        console.log('网络已连接');
        hideOfflineNotice();
        // 自动重新获取数据
        if (document.getElementById('retry-button')) {
          // 如果显示了重试按钮，说明之前获取失败
          getUserLocation()
            .then(position => {
              if (position) {
                const { latitude, longitude } = position.coords;
                fetchWeatherData(`${longitude},${latitude}`);
              } else {
                fetchWeatherData('101010100'); // 默认北京
              }
            })
            .catch(() => fetchWeatherData('101010100'));
        }
      });
    });
    
    // 获取用户位置
    function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          console.log('浏览器不支持地理定位');
          resolve(null);
          return;
        }
        
        navigator.geolocation.getCurrentPosition(
          position => resolve(position),
          error => {
            console.error('获取位置失败:', error);
            resolve(null);
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      });
    }
    
    // 环境检测
    function detectEnvironment() {
      const hostname = window.location.hostname;
      // 设置API基础URL
      window.qweatherKey = '1222d267013b45558ce077a0f9b76afc'; // 和风天气API密钥
      window.baseUrl = 'https://devapi.qweather.com/v7';
      window.geoUrl = 'https://geoapi.qweather.com/v2';
      console.log('使用和风天气API');
    }
    
    // 加载页面缓存
    function initFromCache() {
      const cachedData = localStorage.getItem(cacheName);
      
      if (cachedData) {
        try {
          const data = JSON.parse(cachedData);
          lastUpdate = new Date(data.timestamp);
          const now = new Date();
          const diffMinutes = Math.floor((now - lastUpdate) / (1000 * 60));
          
          // 如果缓存不超过30分钟，使用缓存
          if (diffMinutes < 30 && data.weather) {
            userCity = data.city || '';
            updateUI(data.weather);
            hideLoading();
            
            // 同时在后台获取新数据
            fetchWeatherData(userCity || '101010100').catch(console.error);
            return;
          }
        } catch (e) {
          console.error('缓存解析错误:', e);
        }
      }
      
      // 无缓存或缓存过期，获取新数据
      fetchWeatherData('101010100').catch(handleError); // 默认使用北京
    }
    
    // 获取天气数据
    async function fetchWeatherData(location, cityNameOverride = null) {
      showLoading();
      
      try {
        // 设置显示的地点名
        let displayLocation = location;
        
        // 检查是否为经纬度坐标格式
        const isLatLng = /^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(location);
        
        if (isLatLng) {
          // 经纬度坐标不做显示处理
          console.log('使用经纬度获取天气:', location);
        } else {
          // 根据location显示加载提示
          console.log('使用城市名称/ID获取天气:', location);
        }
        
        try {
          // 调用和风天气API
          let locationId = location;
          let locationName = cityNameOverride || '';
          
          // 如果是经纬度坐标，先通过Geo API获取位置信息
          if (isLatLng) {
            try {
              console.log('开始通过经纬度查询城市信息');
              const geoResponse = await fetch(`${window.geoUrl}/city/lookup?location=${encodeURIComponent(location)}&key=${window.qweatherKey}`);
              const geoData = await geoResponse.json();
              
              console.log('经纬度查询结果:', geoData);
              
              if (geoData.code === '200' && geoData.location && geoData.location.length > 0) {
                locationId = geoData.location[0].id;
                locationName = geoData.location[0].name;
                console.log('解析到城市:', locationName, '城市ID:', locationId);
              } else {
                console.error('地理位置查找失败', geoData);
                showNotification('无法通过经纬度获取城市信息', 'warning');
              }
            } catch (geoError) {
              console.error('地理位置API错误:', geoError);
            }
          }
          
          console.log('开始获取天气数据, 使用位置ID:', locationId);
          
          // 并行获取实时天气、逐小时预报和7天预报
          const [nowResponse, hourlyResponse, dailyResponse, airResponse] = await Promise.all([
            fetch(`${window.baseUrl}/weather/now?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`),
            fetch(`${window.baseUrl}/weather/24h?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`),
            fetch(`${window.baseUrl}/weather/7d?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`),
            fetch(`${window.baseUrl}/air/now?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`)
          ]);
          
          // 检查API响应
          if (!nowResponse.ok || !hourlyResponse.ok || !dailyResponse.ok) {
            console.error('API响应状态码:', 
                          nowResponse.status, 
                          hourlyResponse.status, 
                          dailyResponse.status);
            throw new Error('和风天气API响应错误');
          }
          
          // 解析API响应
          const [nowData, hourlyData, dailyData, airData] = await Promise.all([
            nowResponse.json(),
            hourlyResponse.json(),
            dailyResponse.json(),
            airResponse.json()
          ]);
          
          console.log('接收到天气数据响应:', 
                     '实时天气状态码:', nowData.code,
                     '逐小时预报状态码:', hourlyData.code,
                     '7天预报状态码:', dailyData.code);
          
          // 检查API返回码
          if (nowData.code !== '200' || hourlyData.code !== '200' || dailyData.code !== '200') {
            console.error('API返回错误代码:', 
                         '实时天气:', nowData.code,
                         '逐小时预报:', hourlyData.code,
                         '7天预报:', dailyData.code);
            throw new Error(`API错误: ${nowData.code}`);
          }
          
          // 整合数据
          const data = {
            location: {
              name: locationName || (nowData.location ? nowData.location : locationId),
              country: '中国'
            },
            now: {
              temp: nowData.now.temp,
              feelsLike: nowData.now.feelsLike,
              humidity: nowData.now.humidity,
              windSpeed: nowData.now.windSpeed,
              text: nowData.now.text,
              icon: nowData.now.icon
            },
            hourly: hourlyData.hourly.map(hour => ({
              time: hour.fxTime,
              temp: hour.temp,
              text: hour.text,
              pop: hour.pop || '0',
              windDir: hour.windDir,
              windScale: hour.windScale
            })),
            daily: dailyData.daily.map(day => ({
              fxDate: day.fxDate,
              tempMax: day.tempMax,
              tempMin: day.tempMin,
              textDay: day.textDay,
              textNight: day.textNight,
              humidity: day.humidity,
              uvIndex: day.uvIndex || '0'
            })),
            air: airData.code === '200' ? {
              aqi: airData.now.aqi,
              category: airData.now.category,
              pm10: airData.now.pm10,
              pm2p5: airData.now.pm2p5
            } : null
          };
          
          console.log('天气数据整合完成:', data.location.name);
          
          // 更新缓存
          const cacheData = {
            weather: data,
            city: locationName || locationId,
            timestamp: new Date().toISOString()
          };
          
          localStorage.setItem(cacheName, JSON.stringify(cacheData));
          lastUpdate = new Date();
          userCity = cacheData.city;
          
          console.log('天气数据已缓存，开始更新UI');
          
          // 更新UI
          updateUI(data);
          
          // 成功获取数据的提示
          showNotification(`已更新 ${data.location.name} 的天气数据`, 'success');
          
          // 根据天气状况设置背景和动画
          setWeatherBackground(data.now.text || '');
          
          return;
        } catch (apiError) {
          console.error('和风天气API错误:', apiError);
          
          // 尝试使用缓存
          const cachedData = localStorage.getItem(cacheName);
          if (cachedData) {
            try {
              const parsedCache = JSON.parse(cachedData);
              if (parsedCache.weather) {
                const data = parsedCache.weather;
                // 更新UI
                updateUI(data);
                // 根据天气状况设置背景和动画
                setWeatherBackground(data.now.text || '');
                
                // 显示提示，使用的是缓存数据
                showNotification('API调用失败，使用缓存的天气数据', 'warning');
                
                return;
              }
            } catch (e) {
              console.error('缓存解析错误:', e);
            }
          }
          
          // 如果API调用和缓存都失败，回退到生成模拟数据
          const mockData = generateMockWeatherData(location);
          updateUI(mockData);
          setWeatherBackground(mockData.now.text);
          showNotification('无法获取天气数据，使用模拟数据', 'warning');
        }
      } catch (error) {
        console.error('获取天气数据失败:', error);
        handleError(error);
      } finally {
        hideLoading();
      }
    }
    
    // 更新界面
    function updateUI(data) {
      try {
        // 获取真实城市名
        let cityName = '';
        if (data.location && data.location.name && data.location.name !== 'unknown') {
          cityName = data.location.name;
        } else if (data.city && data.city !== 'unknown') {
          cityName = data.city;
        } else if (data.adm1 && data.adm1 !== 'unknown') {
          cityName = data.adm1;
        } else if (data.adm2 && data.adm2 !== 'unknown') {
          cityName = data.adm2;
        } else if (userCity && userCity !== 'auto:ip' && userCity !== 'unknown') {
          cityName = userCity;
        }
        
        // 如果仍然是unknown或为空，使用当前位置
        if (!cityName || cityName === 'unknown') {
          cityName = '当前位置';
        }
        
        // 更新位置显示
        elements.cityName.textContent = cityName;
        
        // 当前天气信息
        const now = data.now || {};
        elements.currentTemp.textContent = now.temp || now.temperature || '--';
        
        // 天气图标和描述
        const weatherText = now.text || now.weather || '';
        elements.currentDescription.textContent = weatherText;
        
        // 增强天气图标显示效果
        const weatherIcon = getWeatherIcon(weatherText);
        elements.currentIcon.innerHTML = `<div class="animated-icon">${weatherIcon}</div>`;
        
        // 详细信息
        elements.feelsLike.textContent = now.feelsLike || now.feels_like || '--';
        elements.humidity.textContent = now.humidity || '--';
        elements.windSpeed.textContent = now.windSpeed || now.wind_speed || '--';
        
        // 空气质量 - 增强显示效果
        if (data.air) {
          const aqi = data.air.aqi || data.air.air_quality?.aqi || '--';
          const aqiClass = getAQIClass(aqi);
          const aqiText = getAQIText(aqi);
          
          elements.aqiValue.innerHTML = `${aqi} <small style="font-size: 0.7rem; opacity: 0.8;">${aqiText}</small>`;
          elements.aqiValue.className = 'detail-value ' + aqiClass;
        } else {
          elements.aqiValue.innerHTML = `-- <small style="font-size: 0.7rem; opacity: 0.8;">暂无数据</small>`;
          elements.aqiValue.className = 'detail-value';
        }
        
        // 小时预报
        updateHourlyForecast(data.hourly || data.forecasts?.hourly || []);
        
        // 每日预报
        updateDailyForecast(data.daily || data.forecasts?.daily || []);
        
        document.body.classList.add('loaded');
      } catch (error) {
        console.error('更新UI时出错:', error);
      }
    }
    
    // 更新小时预报（横向滚动）
    function updateHourlyForecast(hourlyData) {
      if (!hourlyData || !hourlyData.length) {
        elements.hourlyItems.innerHTML = '<div class="hourly-item">无小时预报数据</div>';
        return;
      }
      
      let html = '';
      
      hourlyData.slice(0, 24).forEach((hour, index) => {
        const time = formatHourTime(hour.fxTime || hour.time);
        const temp = hour.temp || hour.temperature || '--';
        const weather = hour.text || hour.weather || '';
        const icon = getWeatherIcon(weather);
        // 提取其他可能有用的数据
        const pop = hour.pop || hour.precipitation || '--'; // 降水概率
        const windDir = hour.windDir || hour.wind_dir || '--';
        const windScale = hour.windScale || hour.wind_scale || '--';
        
        html += `
          <div class="hourly-item" data-time="${time}" data-weather="${weather}" data-temp="${temp}"
               data-pop="${pop}" data-wind-dir="${windDir}" data-wind-scale="${windScale}">
            <div class="hourly-time">${index === 0 ? '现在' : time}</div>
            <div class="hourly-icon">${icon}</div>
            <div class="hourly-temp">${temp}°</div>
            ${pop !== '--' ? `<div class="hourly-pop" style="font-size: 0.8rem; opacity: 0.7;">降水概率 ${pop}%</div>` : ''}
          </div>
        `;
      });
      
      elements.hourlyItems.innerHTML = html;
      
      // 添加点击事件，显示详细信息
      document.querySelectorAll('.hourly-item').forEach(item => {
        item.addEventListener('click', function() {
          const time = this.getAttribute('data-time');
          const weather = this.getAttribute('data-weather');
          const temp = this.getAttribute('data-temp');
          const pop = this.getAttribute('data-pop');
          const windDir = this.getAttribute('data-wind-dir');
          const windScale = this.getAttribute('data-wind-scale');
          
          // 构建详细信息对话框
          let detailHTML = `
            <div style="padding: 20px; text-align: center;">
              <h3 style="margin-bottom: 10px;">${time === '现在' ? '当前天气' : time}</h3>
              <div style="font-size: 2rem; margin: 10px 0;">${getWeatherIcon(weather)}</div>
              <div style="font-size: 1.5rem; margin: 10px 0;">${temp}° ${weather}</div>
              
              <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                ${pop !== '--' ? `<div><span style="opacity: 0.7;">降水概率</span><br>${pop}%</div>` : ''}
                ${windDir !== '--' ? `<div><span style="opacity: 0.7;">风向</span><br>${windDir}</div>` : ''}
                ${windScale !== '--' ? `<div><span style="opacity: 0.7;">风力</span><br>${windScale}级</div>` : ''}
              </div>
            </div>
          `;
          
          showModal(detailHTML);
        });
      });
      
      // 设置初始滚动位置，显示"现在"
      setTimeout(() => {
        elements.hourlyItems.parentElement.scrollLeft = 0;
      }, 100);
    }
    
    // 更新每日预报
    function updateDailyForecast(dailyData) {
      if (!dailyData || !dailyData.length) {
        elements.forecastContainer.innerHTML = '<div class="forecast-card">无每日预报数据</div>';
        return;
      }
      
      let html = '';
      
      dailyData.forEach((day, index) => {
        const date = formatDate(day.fxDate || day.date);
        const maxTemp = day.tempMax || day.max_temp || '--';
        const minTemp = day.tempMin || day.min_temp || '--';
        const weather = day.textDay || day.weather || '';
        const icon = getWeatherIcon(weather);
        // 提取其他可能有用的信息
        const weatherNight = day.textNight || day.weather_night || weather;
        const humidity = day.humidity || '--';
        const uvIndex = day.uvIndex || day.uv_index || '--';
        
        html += `
          <div class="forecast-card" data-date="${date}" data-weather-day="${weather}" 
               data-weather-night="${weatherNight}" data-max="${maxTemp}" data-min="${minTemp}"
               data-humidity="${humidity}" data-uv="${uvIndex}">
            <div class="forecast-day">${index === 0 ? '今天' : date}</div>
            <div class="forecast-icon">${icon}</div>
            <div class="forecast-temp">
              <span class="max-temp">${maxTemp}°</span>
              <span class="min-temp">${minTemp}°</span>
            </div>
          </div>
        `;
      });
      
      elements.forecastContainer.innerHTML = html;
      
      // 添加点击事件
      document.querySelectorAll('.forecast-card').forEach(card => {
        card.addEventListener('click', function() {
          const date = this.getAttribute('data-date');
          const weatherDay = this.getAttribute('data-weather-day');
          const weatherNight = this.getAttribute('data-weather-night');
          const maxTemp = this.getAttribute('data-max');
          const minTemp = this.getAttribute('data-min');
          const humidity = this.getAttribute('data-humidity');
          const uvIndex = this.getAttribute('data-uv');
          
          // 构建详细信息对话框
          let detailHTML = `
            <div style="padding: 20px; text-align: center;">
              <h3 style="margin-bottom: 10px;">${date === '今天' ? '今日天气' : date}</h3>
              
              <div style="display: flex; justify-content: space-around; margin: 15px 0;">
            <div>
                  <div style="opacity: 0.7;">白天</div>
                  <div style="font-size: 1.5rem; margin: 5px 0;">${getWeatherIcon(weatherDay)}</div>
                  <div>${weatherDay}</div>
            </div>
                <div>
                  <div style="opacity: 0.7;">夜间</div>
                  <div style="font-size: 1.5rem; margin: 5px 0;">${getWeatherIcon(weatherNight)}</div>
                  <div>${weatherNight}</div>
                </div>
              </div>
              
              <div style="font-size: 1.2rem; margin: 15px 0;">
                <span class="max-temp">${maxTemp}°</span> / 
                <span class="min-temp">${minTemp}°</span>
              </div>
              
              <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                ${humidity !== '--' ? `<div><span style="opacity: 0.7;">湿度</span><br>${humidity}%</div>` : ''}
                ${uvIndex !== '--' ? `<div><span style="opacity: 0.7;">紫外线指数</span><br>${getUVIndexText(uvIndex)}</div>` : ''}
              </div>
        </div>
      `;
          
          showModal(detailHTML);
        });
      });
    }
    
    // 获取紫外线指数文字描述
    function getUVIndexText(uvIndex) {
      const index = parseInt(uvIndex);
      if (isNaN(index)) return uvIndex;
      
      if (index <= 2) return `${uvIndex} (低)`;
      if (index <= 5) return `${uvIndex} (中等)`;
      if (index <= 7) return `${uvIndex} (高)`;
      if (index <= 10) return `${uvIndex} (很高)`;
      return `${uvIndex} (极高)`;
    }
    
    // 显示模态对话框
    function showModal(content) {
      // 检查是否已有对话框，如果有则移除
      const existingModal = document.getElementById('weather-modal');
      if (existingModal) {
        document.body.removeChild(existingModal);
      }
      
      // 创建模态对话框
      const modal = document.createElement('div');
      modal.id = 'weather-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      `;
      
      // 创建模态内容
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background-color: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        border-radius: 20px;
        width: 85%;
        max-width: 350px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
      `;
      
      // 设置内容
      modalContent.innerHTML = content;
      
      // 添加关闭按钮
      const closeButton = document.createElement('button');
      closeButton.textContent = '关闭';
      closeButton.className = 'btn-ios';
      closeButton.style.cssText = `
        margin: 15px auto;
        display: block;
        width: 120px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        border-radius: 24px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.5);
      `;
      
      modalContent.appendChild(closeButton);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // 显示动画
      setTimeout(() => {
        modal.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
      }, 10);
      
      // 点击关闭按钮或背景关闭
      closeButton.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // 关闭模态框
      function closeModal() {
        modal.style.opacity = '0';
        modalContent.style.transform = 'scale(0.9)';
        setTimeout(() => {
          document.body.removeChild(modal);
        }, 300);
      }
    }
    
    // 设置天气背景和动画
    function setWeatherBackground(weather) {
      // 首先移除所有天气相关类
      document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'foggy');
      
      // 清除现有的动画元素
      elements.weatherAnimationContainer.innerHTML = '';
      
      // 根据天气类型设置对应的背景和动画
      if (/晴|clear/.test(weather)) {
        document.body.classList.add('sunny');
        createSunnyAnimation();
      } else if (/多云|阴|cloud|overcast/.test(weather)) {
        document.body.classList.add('cloudy');
        createCloudyAnimation();
      } else if (/雨|rain|drizzle|storm/.test(weather)) {
        document.body.classList.add('rainy');
        createRainAnimation();
      } else if (/雪|snow|sleet/.test(weather)) {
        document.body.classList.add('snowy');
        createSnowAnimation();
      } else if (/雾|霾|fog|haze|mist/.test(weather)) {
        document.body.classList.add('foggy');
        createFoggyAnimation();
      } else {
        // 默认设置
        document.body.classList.add('sunny');
      }
    }
    
    // 创建晴天动画
    function createSunnyAnimation() {
      const sun = document.createElement('div');
      sun.style.cssText = `
        position: absolute;
        top: 5%;
        right: 10%;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: radial-gradient(#FFD700, #FF8C00);
        box-shadow: 0 0 50px #FF8C00, 0 0 100px #FFD700;
        opacity: 0.8;
        animation: pulse 3s infinite alternate;
      `;
      
      elements.weatherAnimationContainer.appendChild(sun);
      
      // 添加脉动效果
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse {
          0% { transform: scale(1); opacity: 0.8; }
          100% { transform: scale(1.1); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    }
    
    // 创建多云动画
    function createCloudyAnimation() {
      for (let i = 0; i < 5; i++) {
        const cloud = document.createElement('div');
        const top = Math.random() * 30;
        const left = Math.random() * 80;
        const scale = 0.5 + Math.random() * 0.5;
        const speed = 50 + Math.random() * 50;
        
        cloud.style.cssText = `
          position: absolute;
          top: ${top}%;
          left: ${left}%;
          width: 100px;
          height: 60px;
          background: rgba(255, 255, 255, 0.7);
          border-radius: 50px;
          transform: scale(${scale});
          opacity: 0.7;
          animation: float ${speed}s linear infinite;
        `;
        
        // 创建云朵形状
        const before = document.createElement('div');
        before.style.cssText = `
          position: absolute;
          top: -30px;
          left: 25px;
          width: 60px;
          height: 60px;
          background: rgba(255, 255, 255, 0.7);
          border-radius: 50%;
        `;
        
        const after = document.createElement('div');
        after.style.cssText = `
          position: absolute;
          top: -20px;
          left: 60px;
          width: 40px;
          height: 40px;
          background: rgba(255, 255, 255, 0.7);
          border-radius: 50%;
        `;
        
        cloud.appendChild(before);
        cloud.appendChild(after);
        elements.weatherAnimationContainer.appendChild(cloud);
      }
      
      // 添加浮动效果
      const style = document.createElement('style');
      style.textContent = `
        @keyframes float {
          0% { transform: translateX(-100%) scale(var(--scale, 1)); }
          100% { transform: translateX(100vw) scale(var(--scale, 1)); }
        }
      `;
      document.head.appendChild(style);
    }
    
    // 创建雨天动画
    function createRainAnimation() {
      for (let i = 0; i < 80; i++) {
        const drop = document.createElement('div');
        const left = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = 0.5 + Math.random() * 0.5;
        
        drop.className = 'rain-drop';
        drop.style.cssText = `
          left: ${left}%;
          animation-delay: ${delay}s;
          animation-duration: ${duration}s;
        `;
        
        elements.weatherAnimationContainer.appendChild(drop);
      }
    }
    
    // 创建雪天动画
    function createSnowAnimation() {
      for (let i = 0; i < 50; i++) {
        const flake = document.createElement('div');
        const left = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = 5 + Math.random() * 10;
        const size = 3 + Math.random() * 5;
        
        flake.style.cssText = `
          position: absolute;
          top: -10px;
          left: ${left}%;
          width: ${size}px;
          height: ${size}px;
          background: white;
          border-radius: 50%;
          opacity: 0.8;
          animation: snowfall ${duration}s linear infinite;
          animation-delay: ${delay}s;
        `;
        
        elements.weatherAnimationContainer.appendChild(flake);
      }
      
      // 添加雪花飘落动画
      const style = document.createElement('style');
      style.textContent = `
        @keyframes snowfall {
          0% {
            transform: translateY(-10px) rotate(0deg);
            opacity: 0;
          }
          10% {
            opacity: 1;
          }
          90% {
            opacity: 0.8;
          }
          100% {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
    // 创建雾天动画
    function createFoggyAnimation() {
      for (let i = 0; i < 5; i++) {
        const fog = document.createElement('div');
        const top = 20 + Math.random() * 60;
        
        fog.style.cssText = `
          position: absolute;
          top: ${top}%;
          left: 0;
          width: 100%;
          height: 40px;
          background: rgba(255, 255, 255, 0.3);
          filter: blur(20px);
          animation: fogDrift ${20 + Math.random() * 10}s linear infinite alternate;
        `;
        
        elements.weatherAnimationContainer.appendChild(fog);
      }
      
      // 添加雾漂移动效果
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fogDrift {
          0% { transform: translateX(-5%); }
          100% { transform: translateX(5%); }
        }
      `;
      document.head.appendChild(style);
    }
    
    // 获取天气图标
    function getWeatherIcon(weather) {
      let iconText = weatherIcons[weather] || '🌤';
      
      // 为不同天气状态添加额外的样式
      let iconClass = '';
      if (/晴|clear/.test(weather)) {
        iconClass = 'sunny-icon';
      } else if (/雨|rain/.test(weather)) {
        iconClass = 'rainy-icon';
      } else if (/雪|snow/.test(weather)) {
        iconClass = 'snowy-icon';
      } else if (/云|阴|cloud|overcast/.test(weather)) {
        iconClass = 'cloudy-icon';
      }
      
      return `<span class="${iconClass}" style="font-size: 200%;">${iconText}</span>`;
    }
    
    // 获取空气质量等级样式
    function getAQIClass(aqi) {
      const num = parseInt(aqi);
      if (isNaN(num)) return '';
      
      if (num <= 50) return 'text-success';
      if (num <= 100) return 'text-info';
      if (num <= 150) return 'text-warning';
      return 'text-danger';
    }
    
    // 获取空气质量文字描述
    function getAQIText(aqi) {
      const num = parseInt(aqi);
      if (isNaN(num)) return '';
      
      if (num <= 50) return '优';
      if (num <= 100) return '良';
      if (num <= 150) return '轻度污染';
      if (num <= 200) return '中度污染';
      if (num <= 300) return '重度污染';
      return '严重污染';
    }
    
    // 显示加载动画
    function showLoading() {
      elements.loadingContainer.classList.add('show');
    }
    
    // 隐藏加载动画
    function hideLoading() {
      elements.loadingContainer.classList.remove('show');
    }
    
    // 处理错误
    function handleError(error) {
      console.error('发生错误:', error);
      hideLoading();
      
      // 尝试使用缓存数据
      const cachedData = localStorage.getItem(cacheName);
      if (cachedData) {
        try {
          const parsedData = JSON.parse(cachedData);
          if (parsedData.weather) {
            updateUI(parsedData.weather);
            // 显示提示，使用的是缓存数据
            elements.cityName.textContent = '使用缓存的天气数据';
            elements.currentDescription.innerHTML = `请检查网络连接并重试<br><small style="font-size:0.8rem">上次更新: ${new Date(parsedData.timestamp).toLocaleString()}</small>`;
            
            return;
          }
        } catch (e) {
          console.error('缓存解析错误:', e);
        }
      }
      
      // 显示错误信息
      elements.cityName.textContent = '无法获取天气数据';
      elements.currentDescription.textContent = '请检查网络连接并重试';
      elements.currentTemp.textContent = '--';
      
      // 添加重试按钮
      const retryButton = document.createElement('button');
      retryButton.innerText = '重新尝试';
      retryButton.className = 'btn-ios';
      retryButton.style.cssText = 'margin-top: 1rem; width: 120px; padding: 10px; font-size: 1rem; background-color: rgba(255, 255, 255, 0.3);';
      retryButton.onclick = () => {
        location.reload();
      };
      
      // 清除可能存在的旧按钮
      const existingButton = document.querySelector('#retry-button');
      if (existingButton) {
        existingButton.remove();
      }
      
      // 添加ID以便于后续引用
      retryButton.id = 'retry-button';
      elements.currentDescription.appendChild(document.createElement('br'));
      elements.currentDescription.appendChild(retryButton);
    }
    
    // 显示诊断工具
    function showDiagnosticTools() {
      const diagnosticsArea = document.getElementById('diagnostics-area');
      diagnosticsArea.style.display = 'block';
      
      // 绑定诊断按钮事件
      document.getElementById('run-diagnostics-btn').addEventListener('click', runDiagnostics);
      document.getElementById('toggle-api-btn').addEventListener('click', toggleApiSource);
      document.getElementById('clear-cache-btn').addEventListener('click', clearCache);
    }
    
    // 运行诊断
    async function runDiagnostics() {
      const resultsArea = document.getElementById('diagnostics-results');
      resultsArea.style.display = 'block';
      resultsArea.innerHTML = '正在运行诊断...<br>';
      
      try {
        // 检查网络连接
        resultsArea.innerHTML += `网络连接: ${navigator.onLine ? '在线' : '离线'}<br>`;
        
        // 检查缓存
        const hasCache = localStorage.getItem(cacheName) !== null;
        resultsArea.innerHTML += `本地缓存: ${hasCache ? '存在' : '不存在'}<br>`;
        
        // 检查API服务器配置
        resultsArea.innerHTML += `API基础URL: ${window.baseUrl || '(使用相对路径)'}<br>`;
        
        // 测试不同的API端点
        const endpoints = [
          { name: '标准天气API', url: `${window.baseUrl}/api/weather?location=auto:ip` },
          { name: '直接天气API', url: `${window.baseUrl}/weather?location=auto:ip` },
          { name: '模拟天气API', url: `${window.baseUrl}/mock-weather?location=auto:ip` }
        ];
        
        for (const endpoint of endpoints) {
          try {
            const timingStart = Date.now();
            const response = await fetchWithTimeout(endpoint.url, { timeout: 3000 });
            const pingTime = Date.now() - timingStart;
            
            if (response.ok) {
              resultsArea.innerHTML += `${endpoint.name}: 响应正常 (${pingTime}ms)<br>`;
            } else {
              resultsArea.innerHTML += `${endpoint.name}: 响应错误 ${response.status}<br>`;
            }
          } catch (e) {
            resultsArea.innerHTML += `${endpoint.name}: ${e.message}<br>`;
          }
        }
        
        // 检查浏览器信息
        resultsArea.innerHTML += `浏览器信息: ${navigator.userAgent}<br>`;
        
        // 当前状态
        resultsArea.innerHTML += `使用备用API: ${useFallbackAPI ? '是' : '否'}<br>`;
        resultsArea.innerHTML += `失败尝试次数: ${failedAttempts}<br>`;
        
        // 显示诊断完成和建议
        resultsArea.innerHTML += '<br><strong>诊断建议:</strong><br>';
        if (!navigator.onLine) {
          resultsArea.innerHTML += '- 您当前处于离线状态，请检查网络连接<br>';
        } else if (failedAttempts > 0) {
          resultsArea.innerHTML += '- 尝试切换API<br>';
          resultsArea.innerHTML += '- 清除缓存并重新加载<br>';
          resultsArea.innerHTML += '- 检查网络连接是否受限或代理设置<br>';
        } else {
          resultsArea.innerHTML += '- 暂无异常，请尝试重新加载页面<br>';
        }
      } catch (error) {
        resultsArea.innerHTML += `诊断过程出错: ${error.message}<br>`;
      }
    }
    
    // 切换API
    function toggleApiSource() {
      useFallbackAPI = !useFallbackAPI;
      showNotification(`已切换到${useFallbackAPI ? '备用' : '主要'}API源`, 'info');
      
      // 直接尝试使用新的API源获取数据
      fetchWeatherData(userCity || 'auto:ip');
    }
    
    // 清除缓存
    function clearCache() {
      localStorage.removeItem(cacheName);
      showNotification('已清除缓存', 'info');
      
      // 显示清除完成提示
      const diagnosticsResults = document.getElementById('diagnostics-results');
      diagnosticsResults.style.display = 'block';
      diagnosticsResults.innerHTML = '缓存已清除，请重新加载页面获取新数据';
    }
    
    // 格式化日期(YYYY-MM-DD -> MM月DD日)
    function formatDate(dateStr) {
      if (!dateStr) return '';
      
      try {
        const date = new Date(dateStr);
        return `${date.getMonth() + 1}月${date.getDate()}日`;
      } catch (e) {
        // 使用正则表达式提取月和日
        const match = dateStr.match(/\d{4}-(\d{2})-(\d{2})/);
        if (match) {
          return `${parseInt(match[1])}月${parseInt(match[2])}日`;
        }
        return dateStr;
      }
    }
    
    // 格式化小时时间(YYYY-MM-DD HH:MM:SS -> HH:MM)
    function formatHourTime(timeStr) {
      if (!timeStr) return '';
      
      const match = timeStr.match(/(\d{2}):(\d{2})/);
      if (match) {
        return `${match[1]}:${match[2]}`;
      }
      
      // 尝试从日期字符串中提取时间
      const dateMatch = timeStr.match(/\d{4}-\d{2}-\d{2}T(\d{2}):\d{2}/);
      if (dateMatch) {
        return `${dateMatch[1]}时`;
      }
      
      return timeStr;
    }
    
    // 更新当前日期
    function updateCurrentDate() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      elements.currentDate.textContent = now.toLocaleDateString('zh-CN', options);
    }
    
    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // 生成模拟天气数据（当所有API都失败时使用)
    function generateMockWeatherData(location) {
      const now = new Date();
      const cityName = location !== 'auto:ip' ? location : '当前位置';
      
      // 创建一些合理的模拟数据
      return {
        location: {
          name: cityName,
          country: '中国'
        },
        now: {
          temp: '20',
          feelsLike: '19',
          humidity: '65',
          windSpeed: '3.5',
          text: '多云',
          weather: '多云'
        },
        hourly: Array(24).fill().map((_, i) => {
          const hour = new Date(now);
          hour.setHours(now.getHours() + i);
          return {
            time: hour.toISOString(),
            temp: (20 + Math.sin(i/6) * 5).toFixed(0),
            text: i % 4 === 0 ? '多云' : '晴',
            weather: i % 4 === 0 ? '多云' : '晴',
            pop: (Math.random() * 30).toFixed(0)
          };
        }),
        daily: Array(7).fill().map((_, i) => {
          const day = new Date(now);
          day.setDate(now.getDate() + i);
          return {
            date: day.toISOString().split('T')[0],
            tempMax: (23 + Math.sin(i/2) * 3).toFixed(0),
            tempMin: (14 + Math.sin(i/2) * 2).toFixed(0),
            textDay: i % 3 === 0 ? '多云' : i % 3 === 1 ? '晴' : '小雨',
            textNight: i % 4 === 0 ? '多云' : '晴',
            humidity: (60 + Math.random() * 20).toFixed(0),
            uvIndex: (Math.random() * 10).toFixed(0)
          };
        }),
        air: {
          aqi: '75'
        }
      };
    }
    
    // 添加一个超时功能的fetch
    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 8000 } = options;
      
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      
      try {
        const response = await fetch(resource, {
          ...options,
          signal: controller.signal  
        });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        if (error.name === 'AbortError') {
          throw new Error('请求超时');
        }
        throw error;
      }
    }
    
    // 显示通知
    function showNotification(message, type = 'info') {
      // 移除现有通知
      const existingNotice = document.getElementById('weather-notification');
      if (existingNotice) {
        document.body.removeChild(existingNotice);
      }
      
      // 创建通知元素
      const notice = document.createElement('div');
      notice.id = 'weather-notification';
      notice.style.cssText = `
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        z-index: 9999;
        font-size: 0.9rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 80%;
        text-align: center;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      `;
      
      // 根据类型设置背景色
      if (type === 'warning') {
        notice.style.backgroundColor = 'rgba(255, 152, 0, 0.8)';
      } else if (type === 'error') {
        notice.style.backgroundColor = 'rgba(244, 67, 54, 0.8)';
      } else if (type === 'success') {
        notice.style.backgroundColor = 'rgba(76, 175, 80, 0.8)';
      }
      
      notice.textContent = message;
      document.body.appendChild(notice);
      
      // 显示通知
      setTimeout(() => {
        notice.style.opacity = '1';
      }, 10);
      
      // 3秒后自动隐藏
      setTimeout(() => {
        notice.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(notice)) {
            document.body.removeChild(notice);
          }
        }, 300);
      }, 3000);
    }
    
    // 显示离线通知
    function showOfflineNotice() {
      showNotification('您当前处于离线状态，显示最后缓存的天气数据', 'warning');
      
      // 添加离线指示
      if (!document.getElementById('offline-indicator')) {
        const indicator = document.createElement('div');
        indicator.id = 'offline-indicator';
        indicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background-color: rgba(244, 67, 54, 0.9);
          color: white;
          padding: 8px 15px;
          border-radius: 20px;
          font-size: 0.8rem;
          z-index: 999;
        `;
        indicator.textContent = '离线模式';
        document.body.appendChild(indicator);
      }
    }
    
    // 隐藏离线通知
    function hideOfflineNotice() {
      const indicator = document.getElementById('offline-indicator');
      if (indicator) {
        document.body.removeChild(indicator);
      }
      showNotification('网络已恢复连接', 'success');
    }

    // 显示城市选择器
    function showCitySelector() {
      // 创建模态框
      const modal = document.createElement('div');
      modal.id = 'city-selector-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      `;
      
      // 创建模态内容
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background-color: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        border-radius: 20px;
        width: 85%;
        max-width: 350px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 20px;
      `;
      
      // 标题
      const title = document.createElement('h3');
      title.textContent = '选择城市';
      title.style.cssText = `
        text-align: center;
        margin-bottom: 15px;
      `;
      
      // 搜索输入框
      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.placeholder = '输入城市名称...';
      searchInput.style.cssText = `
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 16px;
        margin-bottom: 15px;
        box-sizing: border-box;
      `;
      
      // 搜索结果容器
      const searchResults = document.createElement('div');
      searchResults.style.cssText = `
        max-height: 250px;
        overflow-y: auto;
        margin-bottom: 15px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 5px;
      `;
      
      // 移除快捷城市选择部分
      
      // 添加当前位置按钮
      const locationBtn = document.createElement('button');
      locationBtn.textContent = '📍 当前位置';
      locationBtn.className = 'btn-ios';
      locationBtn.style.cssText = `
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 15px;
        color: white;
        cursor: pointer;
        margin-bottom: 15px;
        width: 100%;
      `;
      locationBtn.addEventListener('click', () => {
        showNotification('正在获取位置...', 'info');
        getUserLocation()
          .then(position => {
            if (position) {
              const { latitude, longitude } = position.coords;
              fetchWeatherData(`${longitude},${latitude}`);
              showNotification('正在获取当前位置天气...', 'info');
            } else {
              showNotification('无法获取位置，使用默认城市', 'warning');
              fetchWeatherData('101010100', '北京'); // 默认北京
            }
          })
          .catch(error => {
            console.error('位置获取失败:', error);
            showNotification('获取位置失败，使用默认城市', 'error');
            fetchWeatherData('101010100', '北京');
          });
        closeModal();
      });
      
      // 关闭按钮
      const closeButton = document.createElement('button');
      closeButton.textContent = '关闭';
      closeButton.className = 'btn-ios';
      closeButton.style.cssText = `
        width: 100%;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
      `;
      
      // 立即搜索函数(不使用防抖，直接搜索)
      function searchCity(query) {
        if (query.length < 2) {
          searchResults.innerHTML = '';
          return;
        }
        
        searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">搜索中...</div>';
        
        // 直接调用和风天气城市查询API
        const apiUrl = `${window.geoUrl}/city/lookup?location=${encodeURIComponent(query)}&key=${window.qweatherKey}`;
        console.log('搜索城市URL:', apiUrl);
        
        fetch(apiUrl)
          .then(response => {
            console.log('搜索城市接收到响应:', response.status);
            if (!response.ok) {
              throw new Error(`API请求错误: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('城市搜索结果:', data);
            
            if (data.code === '200' && data.location && data.location.length > 0) {
              searchResults.innerHTML = '';
              
              data.location.slice(0, 15).forEach(city => {
                const cityItem = document.createElement('div');
                cityItem.style.cssText = `
                  padding: 12px;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                  cursor: pointer;
                  border-radius: 8px;
                  transition: background-color 0.2s;
                `;
                cityItem.innerHTML = `
                  <div style="font-weight: bold;">${city.name}</div>
                  <div style="font-size: 0.8rem; opacity: 0.8;">${city.adm2 || ''} ${city.adm1 || ''}</div>
                `;
                cityItem.addEventListener('click', () => {
                  showNotification(`正在获取${city.name}的天气数据...`, 'info');
                  fetchWeatherData(city.id, city.name);
                  closeModal();
                });
                cityItem.addEventListener('mouseover', () => {
                  cityItem.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                });
                cityItem.addEventListener('mouseout', () => {
                  cityItem.style.backgroundColor = 'transparent';
                });
                searchResults.appendChild(cityItem);
              });
              
              // 如果没有立即显示结果，添加提示
              if (searchResults.children.length === 0) {
                searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">未找到相关城市</div>';
              }
            } else {
              searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">未找到相关城市</div>';
            }
          })
          .catch(error => {
            console.error('搜索城市失败:', error);
            searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">搜索失败，请重试</div>';
          });
      }
      
      // 绑定搜索按钮
      const searchButton = document.createElement('button');
      searchButton.textContent = '🔍 搜索';
      searchButton.className = 'btn-ios';
      searchButton.style.cssText = `
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 15px;
        color: white;
        cursor: pointer;
        margin-bottom: 15px;
        width: 100%;
      `;
      searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) {
          searchCity(query);
        }
      });
      
      // 输入框回车事件
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = searchInput.value.trim();
          if (query) {
            searchCity(query);
          }
        }
      });
      
      // 组装模态框
      modalContent.appendChild(title);
      modalContent.appendChild(searchInput);
      modalContent.appendChild(searchButton);
      modalContent.appendChild(searchResults);
      modalContent.appendChild(locationBtn);
      modalContent.appendChild(closeButton);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // 显示模态框并聚焦搜索框
      setTimeout(() => {
        modal.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
        searchInput.focus();
      }, 10);
      
      // 点击关闭按钮或背景关闭
      closeButton.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // 关闭模态框
      function closeModal() {
        modal.style.opacity = '0';
        modalContent.style.transform = 'scale(0.9)';
        setTimeout(() => {
          document.body.removeChild(modal);
        }, 300);
      }
    }
  </script>
</body>
</html>

