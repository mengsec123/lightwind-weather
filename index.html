<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤©æ°”é¢„æŠ¥</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', system-ui, sans-serif;
      color: #fff;
      background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.5s ease;
    }
    
    body.sunny {
      background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
    }
    
    body.cloudy {
      background: linear-gradient(135deg, #7F7FD5 0%, #91EAE4 100%);
    }
    
    body.rainy {
      background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
    }
    
    body.snowy {
      background: linear-gradient(135deg, #83a4d4 0%, #b6fbff 100%);
    }
    
    body.foggy {
      background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%);
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
    }
    
    /* å¡ç‰‡é€šç”¨æ ·å¼ */
    .card {
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      margin-bottom: 15px;
      padding: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
    }
    
    /* é¡¶éƒ¨åŒºåŸŸ */
    .header {
      padding: 0.8rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .location-display {
      display: flex;
      align-items: center;
    }
    
    .location-icon {
      font-size: 1.4rem;
      opacity: 0.9;
    }
    
    /* æœç´¢å®¹å™¨ */
    .search-container {
      width: 100%;
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      position: relative;
      z-index: 10; /* ç¡®ä¿æœç´¢åŒºåŸŸåœ¨æœ€ä¸Šå±‚ */
    }
    
    .search-bar {
      width: 80%;
      max-width: 300px;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 20px;
      border: none;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #fff;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .search-input:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .search-results {
      position: absolute;
      width: 100%;
      background: rgba(40, 40, 40, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 12px;
      margin-top: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      left: 0;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .search-results.show {
      display: block;
    }
    
    .search-result-item {
      padding: 0.75rem 1rem;
      color: #fff;
      cursor: pointer;
    }
    
    .search-result-item:hover,
    .search-result-item:active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* ä¸»å†…å®¹åŒº */
    .main-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1rem;
    }
    
    /* åˆå¹¶åçš„åŸå¸‚ä¿¡æ¯å’Œæ¸©åº¦å¡ç‰‡ */
    .city-info-temperature-card {
      text-align: center;
      margin-bottom: 1.5rem;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px 15px;
      width: 100%;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .city-name {
      font-size: 2.2rem;
      font-weight: 400;
      margin-bottom: 0.2rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    
    /* æ·»åŠ ç‚¹å‡»æç¤ºæ ·å¼ */
    .city-name:after {
      content: 'â–¼';
      font-size: 0.8rem;
      position: absolute;
      top: 5px;
      right: -20px;
      opacity: 0.8;
    }
    
    .current-date {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }
    
    /* æ¸©åº¦æ˜¾ç¤º */
    .temperature-display {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0.5rem 0;
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    .current-temp {
      font-size: 6rem;
      font-weight: 200;
      line-height: 1;
      margin-right: 10px;
    }
    
    .weather-icon {
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .weather-description {
      font-size: 1.4rem;
      margin-left: 12px;
      padding-right: 5px;
    }
    
    /* åˆå¹¶å¤©æ°”è¯¦æƒ…å’Œæ¸©åº¦å¡ç‰‡çš„æ ·å¼ */
    .weather-details {
      display: flex;
      justify-content: space-around;
      width: 100%;
      max-width: 500px;
      margin: 10px auto 0;
      padding: 10px 5px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      flex-wrap: nowrap;
    }
    
    .detail-col {
      text-align: center;
      padding: 0 5px;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    
    .detail-label {
      opacity: 0.8;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
    }
    
    .detail-value {
      font-weight: 500;
    }
    
    /* å°æ—¶é¢„æŠ¥åŒºåŸŸ - æ¨ªå‘æ»šåŠ¨ */
    .hourly-forecast-section {
      width: 100%;
      margin-bottom: 1.5rem;
      position: relative;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .hourly-scroll {
      overflow-x: auto;
      white-space: nowrap;
      padding: 1rem 0;
      -ms-overflow-style: none;
      scrollbar-width: none;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .hourly-scroll::-webkit-scrollbar {
      display: none;
    }
    
    .hourly-items {
      display: inline-flex;
      padding: 0 0.5rem;
    }
    
    .hourly-item {
      text-align: center;
      padding: 0.8rem 0.8rem;
      min-width: 60px;
      border-radius: 12px;
      transition: transform 0.2s ease, background-color 0.2s ease;
      background-color: rgba(255, 255, 255, 0.15);
      margin: 0 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .hourly-item:active {
      transform: scale(0.95);
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .hourly-time {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      opacity: 0.9;
    }
    
    .hourly-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 0.5rem;
      transform-origin: center;
      transition: transform 0.3s ease;
    }
    
    .hourly-item:hover .hourly-icon,
    .hourly-item:active .hourly-icon {
      transform: scale(1.1);
    }
    
    .hourly-temp {
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    /* å¤©æ°”é¢„æŠ¥å¡ç‰‡ */
    .forecast-section {
      width: 100%;
      margin-bottom: 1.5rem;
      background-color: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .forecast-card {
      display: flex;
      align-items: center;
      padding: 1rem 0.8rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      transition: background-color 0.2s ease, transform 0.2s ease;
      background-color: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .forecast-card:active {
      background-color: rgba(255, 255, 255, 0.3);
      transform: scale(0.99);
    }
    
    .forecast-day {
      width: 30%;
      font-weight: 500;
    }
    
    .forecast-icon {
      width: 20%;
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .forecast-card:hover .forecast-icon,
    .forecast-card:active .forecast-icon {
      transform: scale(1.2);
    }
    
    .forecast-temp {
      width: 50%;
      text-align: right;
      font-size: 1.1rem;
    }
    
    .max-temp {
      font-weight: 500;
      margin-right: 0.8rem;
    }
    
    .min-temp {
      opacity: 0.8;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading-container.show {
      opacity: 1;
      visibility: visible;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* å¤©æ°”åŠ¨ç”» */
    .weather-animation {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    
    @keyframes rain-drop {
      0% {
        opacity: 0;
        transform: translateY(-100vh);
      }
      10% {
        opacity: 1;
      }
      95% {
        opacity: 0.8;
      }
      100% {
        opacity: 0;
        transform: translateY(100vh);
      }
    }
    
    .rain-drop {
      position: fixed;
      width: 1px;
      height: 15px;
      background-color: rgba(255, 255, 255, 0.6);
      animation: rain-drop linear infinite;
      z-index: -1;
    }
    
    /* æŒ‰é’®æ ·å¼ */
    .btn-ios {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-ios:active {
      transform: scale(0.98);
      background-color: rgba(255, 255, 255, 0.25);
    }
    
    /* å¤©æ°”å›¾æ ‡åŠ¨ç”» */
    .animated-icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      transform-origin: center;
    }
    
    .sunny-icon {
      animation: sun-pulse 3s infinite alternate;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    }
    
    .rainy-icon {
      animation: rain-shake 1s infinite ease-in-out;
      text-shadow: 0 0 10px rgba(100, 149, 237, 0.7);
    }
    
    .snowy-icon {
      animation: snow-float 3s infinite ease-in-out;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
    }
    
    .cloudy-icon {
      animation: cloud-drift 4s infinite alternate;
      text-shadow: 0 0 8px rgba(169, 169, 169, 0.7);
    }
    
    @keyframes sun-pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.15); }
    }
    
    @keyframes rain-shake {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-1px, 1px); }
      50% { transform: translate(0, 1px); }
      75% { transform: translate(1px, 0); }
      100% { transform: translate(0, 0); }
    }
    
    @keyframes snow-float {
      0% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-3px) rotate(5deg); }
      100% { transform: translateY(0) rotate(0deg); }
    }
    
    @keyframes cloud-drift {
      0% { transform: translateX(-3px); }
      100% { transform: translateX(3px); }
    }
    
    /* ç©ºæ°”è´¨é‡æŒ‡æ•°æ ·å¼ */
    .text-success {
      color: #4caf50;
    }
    
    .text-info {
      color: #2196f3;
    }
    
    .text-warning {
      color: #ff9800;
    }
    
    .text-danger {
      color: #f44336;
    }
  </style>
</head>
<body>
  <!-- åŠ è½½åŠ¨ç”» -->
  <div class="loading-container" id="loading-container">
    <div class="spinner"></div>
  </div>

  <!-- å¤©æ°”åŠ¨ç”» -->
  <div id="weather-animation-container" class="weather-animation"></div>

  <div class="container">
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
      <!-- åˆå¹¶çš„åŸå¸‚ä¿¡æ¯ã€æ¸©åº¦å’Œå¤©æ°”è¯¦æƒ…å¡ç‰‡ -->
      <div class="city-info-temperature-card">
        <!-- å¯ç‚¹å‡»çš„åŸå¸‚åï¼Œç”¨äºé€‰æ‹©åŸå¸‚ -->
        <h1 id="city-name" class="city-name" style="cursor: pointer;">æ­£åœ¨è·å–...</h1>
        <p id="current-date" class="current-date"></p>
        
        <div class="temperature-display">
          <div class="current-temp"><span id="current-temp">--</span>Â°</div>
          <div style="display: flex; align-items: center; margin-left: 5px;">
            <div id="weather-icon" class="weather-icon"></div>
            <div id="current-description" class="weather-description">è·å–ä¸­...</div>
          </div>
        </div>
        
        <!-- å°†è¯¦ç»†ä¿¡æ¯éƒ¨åˆ†åˆå¹¶åˆ°åŸå¸‚æ¸©åº¦å¡ç‰‡ä¸­ -->
        <div class="weather-details" style="background: none; border: none; box-shadow: none; margin-top: 0.5rem;">
          <div class="detail-col">
            <div class="detail-label">ä½“æ„Ÿæ¸©åº¦</div>
            <div class="detail-value"><span id="feels-like">--</span>Â°</div>
          </div>
          <div class="detail-col">
            <div class="detail-label">æ¹¿åº¦</div>
            <div class="detail-value"><span id="humidity">--</span>%</div>
          </div>
          <div class="detail-col">
            <div class="detail-label">é£é€Ÿ</div>
            <div class="detail-value"><span id="wind-speed">--</span> km/h</div>
          </div>
          <div class="detail-col">
            <div class="detail-label">ç©ºæ°”è´¨é‡</div>
            <div class="detail-value"><span id="aqi-value">--</span></div>
          </div>
        </div>
      </div>
      
      <!-- åˆ é™¤åŸæ¥ç‹¬ç«‹çš„å¤©æ°”è¯¦æƒ…å¡ç‰‡ -->
      
      <!-- å°æ—¶é¢„æŠ¥ - æ¨ªå‘æ»šåŠ¨ -->
      <section class="hourly-forecast-section">
        <div class="hourly-scroll">
          <div id="hourly-items" class="hourly-items">
            <!-- åŠ¨æ€ç”Ÿæˆçš„å°æ—¶é¢„æŠ¥ -->
          </div>
        </div>
      </section>
      
      <!-- ä¸ƒå¤©é¢„æŠ¥ -->
      <section class="forecast-section">
        <div id="forecast-container">
          <!-- åŠ¨æ€ç”Ÿæˆçš„é¢„æŠ¥å¡ç‰‡ -->
        </div>
      </section>
    </main>
  </div>

  <script>
    // å…¨å±€å˜é‡
    const elements = {
      loadingContainer: document.getElementById('loading-container'),
      cityName: document.getElementById('city-name'),
      currentDate: document.getElementById('current-date'),
      currentTemp: document.getElementById('current-temp'),
      currentIcon: document.getElementById('weather-icon'),
      currentDescription: document.getElementById('current-description'),
      feelsLike: document.getElementById('feels-like'),
      humidity: document.getElementById('humidity'),
      windSpeed: document.getElementById('wind-speed'),
      aqiValue: document.getElementById('aqi-value'),
      hourlyItems: document.getElementById('hourly-items'),
      forecastContainer: document.getElementById('forecast-container'),
      weatherAnimationContainer: document.getElementById('weather-animation-container')
    };

    // æœ¬åœ°ç¼“å­˜å˜é‡
    let cacheName = 'weatherCache';
    let userCity = '';
    let lastUpdate = null;
    let failedAttempts = 0; // è·Ÿè¸ªå¤±è´¥å°è¯•
    let useFallbackAPI = true; // é»˜è®¤ä½¿ç”¨å¤‡ç”¨API
    
    // å¤©æ°”å›¾æ ‡æ˜ å°„
    const weatherIcons = {
      'æ™´': 'â˜€',
      'å¤šäº‘': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§',
      'ä¸­é›¨': 'ğŸŒ§',
      'å¤§é›¨': 'ğŸŒ§',
      'æš´é›¨': 'â›ˆï¸',
      'é›·é˜µé›¨': 'â›ˆï¸',
      'é›ª': 'â„ï¸',
      'é›¾': 'ğŸŒ«',
      'clear-day': 'â˜€',
      'clear-night': 'ğŸŒ™',
      'partly-cloudy-day': 'â˜ï¸',
      'partly-cloudy-night': 'ğŸŒ¥',
      'cloudy': 'â˜ï¸',
      'rain': 'ğŸŒ§',
      'snow': 'â„ï¸',
      'wind': 'ğŸ’¨',
      'fog': 'ğŸŒ«',
      'thunderstorm': 'â›ˆï¸'
    };
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      showLoading();
      updateCurrentDate();
      detectEnvironment();
      
      // è·å–ç”¨æˆ·ä½ç½®å¹¶åŠ è½½å¤©æ°”
      getUserLocation()
        .then(position => {
          if (position) {
            const { latitude, longitude } = position.coords;
            fetchWeatherData(`${longitude},${latitude}`);
          } else {
            // å¦‚æœæ— æ³•è·å–ä½ç½®ï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜
            initFromCache();
          }
        })
        .catch(error => {
          console.error('ä½ç½®è·å–å¤±è´¥:', error);
          initFromCache();
        });
      
      // æ·»åŠ åŸå¸‚åç‚¹å‡»äº‹ä»¶ - ç”¨äºé€‰æ‹©åŸå¸‚
      if (elements.cityName) {
        elements.cityName.addEventListener('click', () => {
          showCitySelector();
        });
      }
      
      // æ³¨å†Œç¦»çº¿äº‹ä»¶å¤„ç†
      window.addEventListener('offline', () => {
        console.log('ç½‘ç»œå·²æ–­å¼€');
        showOfflineNotice();
      });
      
      window.addEventListener('online', () => {
        console.log('ç½‘ç»œå·²è¿æ¥');
        hideOfflineNotice();
        // è‡ªåŠ¨é‡æ–°è·å–æ•°æ®
        if (document.getElementById('retry-button')) {
          // å¦‚æœæ˜¾ç¤ºäº†é‡è¯•æŒ‰é’®ï¼Œè¯´æ˜ä¹‹å‰è·å–å¤±è´¥
          getUserLocation()
            .then(position => {
              if (position) {
                const { latitude, longitude } = position.coords;
                fetchWeatherData(`${longitude},${latitude}`);
              } else {
                fetchWeatherData('101010100'); // é»˜è®¤åŒ—äº¬
              }
            })
            .catch(() => fetchWeatherData('101010100'));
        }
      });
    });
    
    // è·å–ç”¨æˆ·ä½ç½®
    function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          console.log('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½');
          resolve(null);
          return;
        }
        
        navigator.geolocation.getCurrentPosition(
          position => resolve(position),
          error => {
            console.error('è·å–ä½ç½®å¤±è´¥:', error);
            resolve(null);
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      });
    }
    
    // ç¯å¢ƒæ£€æµ‹
    function detectEnvironment() {
      const hostname = window.location.hostname;
      // è®¾ç½®APIåŸºç¡€URL
      window.qweatherKey = '1222d267013b45558ce077a0f9b76afc'; // å’Œé£å¤©æ°”APIå¯†é’¥
      window.baseUrl = 'https://devapi.qweather.com/v7';
      window.geoUrl = 'https://geoapi.qweather.com/v2';
      console.log('ä½¿ç”¨å’Œé£å¤©æ°”API');
    }
    
    // åŠ è½½é¡µé¢ç¼“å­˜
    function initFromCache() {
      const cachedData = localStorage.getItem(cacheName);
      
      if (cachedData) {
        try {
          const data = JSON.parse(cachedData);
          lastUpdate = new Date(data.timestamp);
          const now = new Date();
          const diffMinutes = Math.floor((now - lastUpdate) / (1000 * 60));
          
          // å¦‚æœç¼“å­˜ä¸è¶…è¿‡30åˆ†é’Ÿï¼Œä½¿ç”¨ç¼“å­˜
          if (diffMinutes < 30 && data.weather) {
            userCity = data.city || '';
            updateUI(data.weather);
            hideLoading();
            
            // åŒæ—¶åœ¨åå°è·å–æ–°æ•°æ®
            fetchWeatherData(userCity || '101010100').catch(console.error);
            return;
          }
        } catch (e) {
          console.error('ç¼“å­˜è§£æé”™è¯¯:', e);
        }
      }
      
      // æ— ç¼“å­˜æˆ–ç¼“å­˜è¿‡æœŸï¼Œè·å–æ–°æ•°æ®
      fetchWeatherData('101010100').catch(handleError); // é»˜è®¤ä½¿ç”¨åŒ—äº¬
    }
    
    // è·å–å¤©æ°”æ•°æ®
    async function fetchWeatherData(location, cityNameOverride = null) {
      showLoading();
      
      try {
        // è®¾ç½®æ˜¾ç¤ºçš„åœ°ç‚¹å
        let displayLocation = location;
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç»çº¬åº¦åæ ‡æ ¼å¼
        const isLatLng = /^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(location);
        
        if (isLatLng) {
          // ç»çº¬åº¦åæ ‡ä¸åšæ˜¾ç¤ºå¤„ç†
          console.log('ä½¿ç”¨ç»çº¬åº¦è·å–å¤©æ°”:', location);
        } else {
          // æ ¹æ®locationæ˜¾ç¤ºåŠ è½½æç¤º
          console.log('ä½¿ç”¨åŸå¸‚åç§°/IDè·å–å¤©æ°”:', location);
        }
        
        try {
          // è°ƒç”¨å’Œé£å¤©æ°”API
          let locationId = location;
          let locationName = cityNameOverride || '';
          
          // å¦‚æœæ˜¯ç»çº¬åº¦åæ ‡ï¼Œå…ˆé€šè¿‡Geo APIè·å–ä½ç½®ä¿¡æ¯
          if (isLatLng) {
            try {
              console.log('å¼€å§‹é€šè¿‡ç»çº¬åº¦æŸ¥è¯¢åŸå¸‚ä¿¡æ¯');
              const geoResponse = await fetch(`${window.geoUrl}/city/lookup?location=${encodeURIComponent(location)}&key=${window.qweatherKey}`);
              const geoData = await geoResponse.json();
              
              console.log('ç»çº¬åº¦æŸ¥è¯¢ç»“æœ:', geoData);
              
              if (geoData.code === '200' && geoData.location && geoData.location.length > 0) {
                locationId = geoData.location[0].id;
                locationName = geoData.location[0].name;
                console.log('è§£æåˆ°åŸå¸‚:', locationName, 'åŸå¸‚ID:', locationId);
              } else {
                console.error('åœ°ç†ä½ç½®æŸ¥æ‰¾å¤±è´¥', geoData);
                showNotification('æ— æ³•é€šè¿‡ç»çº¬åº¦è·å–åŸå¸‚ä¿¡æ¯', 'warning');
              }
            } catch (geoError) {
              console.error('åœ°ç†ä½ç½®APIé”™è¯¯:', geoError);
            }
          }
          
          console.log('å¼€å§‹è·å–å¤©æ°”æ•°æ®, ä½¿ç”¨ä½ç½®ID:', locationId);
          
          // å¹¶è¡Œè·å–å®æ—¶å¤©æ°”ã€é€å°æ—¶é¢„æŠ¥å’Œ7å¤©é¢„æŠ¥
          const [nowResponse, hourlyResponse, dailyResponse, airResponse] = await Promise.all([
            fetch(`${window.baseUrl}/weather/now?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`),
            fetch(`${window.baseUrl}/weather/24h?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`),
            fetch(`${window.baseUrl}/weather/7d?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`),
            fetch(`${window.baseUrl}/air/now?location=${encodeURIComponent(locationId)}&key=${window.qweatherKey}`)
          ]);
          
          // æ£€æŸ¥APIå“åº”
          if (!nowResponse.ok || !hourlyResponse.ok || !dailyResponse.ok) {
            console.error('APIå“åº”çŠ¶æ€ç :', 
                          nowResponse.status, 
                          hourlyResponse.status, 
                          dailyResponse.status);
            throw new Error('å’Œé£å¤©æ°”APIå“åº”é”™è¯¯');
          }
          
          // è§£æAPIå“åº”
          const [nowData, hourlyData, dailyData, airData] = await Promise.all([
            nowResponse.json(),
            hourlyResponse.json(),
            dailyResponse.json(),
            airResponse.json()
          ]);
          
          console.log('æ¥æ”¶åˆ°å¤©æ°”æ•°æ®å“åº”:', 
                     'å®æ—¶å¤©æ°”çŠ¶æ€ç :', nowData.code,
                     'é€å°æ—¶é¢„æŠ¥çŠ¶æ€ç :', hourlyData.code,
                     '7å¤©é¢„æŠ¥çŠ¶æ€ç :', dailyData.code);
          
          // æ£€æŸ¥APIè¿”å›ç 
          if (nowData.code !== '200' || hourlyData.code !== '200' || dailyData.code !== '200') {
            console.error('APIè¿”å›é”™è¯¯ä»£ç :', 
                         'å®æ—¶å¤©æ°”:', nowData.code,
                         'é€å°æ—¶é¢„æŠ¥:', hourlyData.code,
                         '7å¤©é¢„æŠ¥:', dailyData.code);
            throw new Error(`APIé”™è¯¯: ${nowData.code}`);
          }
          
          // æ•´åˆæ•°æ®
          const data = {
            location: {
              name: locationName || (nowData.location ? nowData.location : locationId),
              country: 'ä¸­å›½'
            },
            now: {
              temp: nowData.now.temp,
              feelsLike: nowData.now.feelsLike,
              humidity: nowData.now.humidity,
              windSpeed: nowData.now.windSpeed,
              text: nowData.now.text,
              icon: nowData.now.icon
            },
            hourly: hourlyData.hourly.map(hour => ({
              time: hour.fxTime,
              temp: hour.temp,
              text: hour.text,
              pop: hour.pop || '0',
              windDir: hour.windDir,
              windScale: hour.windScale
            })),
            daily: dailyData.daily.map(day => ({
              fxDate: day.fxDate,
              tempMax: day.tempMax,
              tempMin: day.tempMin,
              textDay: day.textDay,
              textNight: day.textNight,
              humidity: day.humidity,
              uvIndex: day.uvIndex || '0'
            })),
            air: airData.code === '200' ? {
              aqi: airData.now.aqi,
              category: airData.now.category,
              pm10: airData.now.pm10,
              pm2p5: airData.now.pm2p5
            } : null
          };
          
          console.log('å¤©æ°”æ•°æ®æ•´åˆå®Œæˆ:', data.location.name);
          
          // æ›´æ–°ç¼“å­˜
          const cacheData = {
            weather: data,
            city: locationName || locationId,
            timestamp: new Date().toISOString()
          };
          
          localStorage.setItem(cacheName, JSON.stringify(cacheData));
          lastUpdate = new Date();
          userCity = cacheData.city;
          
          console.log('å¤©æ°”æ•°æ®å·²ç¼“å­˜ï¼Œå¼€å§‹æ›´æ–°UI');
          
          // æ›´æ–°UI
          updateUI(data);
          
          // æˆåŠŸè·å–æ•°æ®çš„æç¤º
          showNotification(`å·²æ›´æ–° ${data.location.name} çš„å¤©æ°”æ•°æ®`, 'success');
          
          // æ ¹æ®å¤©æ°”çŠ¶å†µè®¾ç½®èƒŒæ™¯å’ŒåŠ¨ç”»
          setWeatherBackground(data.now.text || '');
          
          return;
        } catch (apiError) {
          console.error('å’Œé£å¤©æ°”APIé”™è¯¯:', apiError);
          
          // å°è¯•ä½¿ç”¨ç¼“å­˜
          const cachedData = localStorage.getItem(cacheName);
          if (cachedData) {
            try {
              const parsedCache = JSON.parse(cachedData);
              if (parsedCache.weather) {
                const data = parsedCache.weather;
                // æ›´æ–°UI
                updateUI(data);
                // æ ¹æ®å¤©æ°”çŠ¶å†µè®¾ç½®èƒŒæ™¯å’ŒåŠ¨ç”»
                setWeatherBackground(data.now.text || '');
                
                // æ˜¾ç¤ºæç¤ºï¼Œä½¿ç”¨çš„æ˜¯ç¼“å­˜æ•°æ®
                showNotification('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜çš„å¤©æ°”æ•°æ®', 'warning');
                
                return;
              }
            } catch (e) {
              console.error('ç¼“å­˜è§£æé”™è¯¯:', e);
            }
          }
          
          // å¦‚æœAPIè°ƒç”¨å’Œç¼“å­˜éƒ½å¤±è´¥ï¼Œå›é€€åˆ°ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
          const mockData = generateMockWeatherData(location);
          updateUI(mockData);
          setWeatherBackground(mockData.now.text);
          showNotification('æ— æ³•è·å–å¤©æ°”æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', 'warning');
        }
      } catch (error) {
        console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥:', error);
        handleError(error);
      } finally {
        hideLoading();
      }
    }
    
    // æ›´æ–°ç•Œé¢
    function updateUI(data) {
      try {
        // è·å–çœŸå®åŸå¸‚å
        let cityName = '';
        if (data.location && data.location.name && data.location.name !== 'unknown') {
          cityName = data.location.name;
        } else if (data.city && data.city !== 'unknown') {
          cityName = data.city;
        } else if (data.adm1 && data.adm1 !== 'unknown') {
          cityName = data.adm1;
        } else if (data.adm2 && data.adm2 !== 'unknown') {
          cityName = data.adm2;
        } else if (userCity && userCity !== 'auto:ip' && userCity !== 'unknown') {
          cityName = userCity;
        }
        
        // å¦‚æœä»ç„¶æ˜¯unknownæˆ–ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰ä½ç½®
        if (!cityName || cityName === 'unknown') {
          cityName = 'å½“å‰ä½ç½®';
        }
        
        // æ›´æ–°ä½ç½®æ˜¾ç¤º
        elements.cityName.textContent = cityName;
        
        // å½“å‰å¤©æ°”ä¿¡æ¯
        const now = data.now || {};
        elements.currentTemp.textContent = now.temp || now.temperature || '--';
        
        // å¤©æ°”å›¾æ ‡å’Œæè¿°
        const weatherText = now.text || now.weather || '';
        elements.currentDescription.textContent = weatherText;
        
        // å¢å¼ºå¤©æ°”å›¾æ ‡æ˜¾ç¤ºæ•ˆæœ
        const weatherIcon = getWeatherIcon(weatherText);
        elements.currentIcon.innerHTML = `<div class="animated-icon">${weatherIcon}</div>`;
        
        // è¯¦ç»†ä¿¡æ¯
        elements.feelsLike.textContent = now.feelsLike || now.feels_like || '--';
        elements.humidity.textContent = now.humidity || '--';
        elements.windSpeed.textContent = now.windSpeed || now.wind_speed || '--';
        
        // ç©ºæ°”è´¨é‡ - å¢å¼ºæ˜¾ç¤ºæ•ˆæœ
        if (data.air) {
          const aqi = data.air.aqi || data.air.air_quality?.aqi || '--';
          const aqiClass = getAQIClass(aqi);
          const aqiText = getAQIText(aqi);
          
          elements.aqiValue.innerHTML = `${aqi} <small style="font-size: 0.7rem; opacity: 0.8;">${aqiText}</small>`;
          elements.aqiValue.className = 'detail-value ' + aqiClass;
        } else {
          elements.aqiValue.innerHTML = `-- <small style="font-size: 0.7rem; opacity: 0.8;">æš‚æ— æ•°æ®</small>`;
          elements.aqiValue.className = 'detail-value';
        }
        
        // å°æ—¶é¢„æŠ¥
        updateHourlyForecast(data.hourly || data.forecasts?.hourly || []);
        
        // æ¯æ—¥é¢„æŠ¥
        updateDailyForecast(data.daily || data.forecasts?.daily || []);
        
        document.body.classList.add('loaded');
      } catch (error) {
        console.error('æ›´æ–°UIæ—¶å‡ºé”™:', error);
      }
    }
    
    // æ›´æ–°å°æ—¶é¢„æŠ¥ï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰
    function updateHourlyForecast(hourlyData) {
      if (!hourlyData || !hourlyData.length) {
        elements.hourlyItems.innerHTML = '<div class="hourly-item">æ— å°æ—¶é¢„æŠ¥æ•°æ®</div>';
        return;
      }
      
      let html = '';
      
      hourlyData.slice(0, 24).forEach((hour, index) => {
        const time = formatHourTime(hour.fxTime || hour.time);
        const temp = hour.temp || hour.temperature || '--';
        const weather = hour.text || hour.weather || '';
        const icon = getWeatherIcon(weather);
        // æå–å…¶ä»–å¯èƒ½æœ‰ç”¨çš„æ•°æ®
        const pop = hour.pop || hour.precipitation || '--'; // é™æ°´æ¦‚ç‡
        const windDir = hour.windDir || hour.wind_dir || '--';
        const windScale = hour.windScale || hour.wind_scale || '--';
        
        html += `
          <div class="hourly-item" data-time="${time}" data-weather="${weather}" data-temp="${temp}"
               data-pop="${pop}" data-wind-dir="${windDir}" data-wind-scale="${windScale}">
            <div class="hourly-time">${index === 0 ? 'ç°åœ¨' : time}</div>
            <div class="hourly-icon">${icon}</div>
            <div class="hourly-temp">${temp}Â°</div>
            ${pop !== '--' ? `<div class="hourly-pop" style="font-size: 0.8rem; opacity: 0.7;">é™æ°´æ¦‚ç‡ ${pop}%</div>` : ''}
          </div>
        `;
      });
      
      elements.hourlyItems.innerHTML = html;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
      document.querySelectorAll('.hourly-item').forEach(item => {
        item.addEventListener('click', function() {
          const time = this.getAttribute('data-time');
          const weather = this.getAttribute('data-weather');
          const temp = this.getAttribute('data-temp');
          const pop = this.getAttribute('data-pop');
          const windDir = this.getAttribute('data-wind-dir');
          const windScale = this.getAttribute('data-wind-scale');
          
          // æ„å»ºè¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†
          let detailHTML = `
            <div style="padding: 20px; text-align: center;">
              <h3 style="margin-bottom: 10px;">${time === 'ç°åœ¨' ? 'å½“å‰å¤©æ°”' : time}</h3>
              <div style="font-size: 2rem; margin: 10px 0;">${getWeatherIcon(weather)}</div>
              <div style="font-size: 1.5rem; margin: 10px 0;">${temp}Â° ${weather}</div>
              
              <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                ${pop !== '--' ? `<div><span style="opacity: 0.7;">é™æ°´æ¦‚ç‡</span><br>${pop}%</div>` : ''}
                ${windDir !== '--' ? `<div><span style="opacity: 0.7;">é£å‘</span><br>${windDir}</div>` : ''}
                ${windScale !== '--' ? `<div><span style="opacity: 0.7;">é£åŠ›</span><br>${windScale}çº§</div>` : ''}
              </div>
            </div>
          `;
          
          showModal(detailHTML);
        });
      });
      
      // è®¾ç½®åˆå§‹æ»šåŠ¨ä½ç½®ï¼Œæ˜¾ç¤º"ç°åœ¨"
      setTimeout(() => {
        elements.hourlyItems.parentElement.scrollLeft = 0;
      }, 100);
    }
    
    // æ›´æ–°æ¯æ—¥é¢„æŠ¥
    function updateDailyForecast(dailyData) {
      if (!dailyData || !dailyData.length) {
        elements.forecastContainer.innerHTML = '<div class="forecast-card">æ— æ¯æ—¥é¢„æŠ¥æ•°æ®</div>';
        return;
      }
      
      let html = '';
      
      dailyData.forEach((day, index) => {
        const date = formatDate(day.fxDate || day.date);
        const maxTemp = day.tempMax || day.max_temp || '--';
        const minTemp = day.tempMin || day.min_temp || '--';
        const weather = day.textDay || day.weather || '';
        const icon = getWeatherIcon(weather);
        // æå–å…¶ä»–å¯èƒ½æœ‰ç”¨çš„ä¿¡æ¯
        const weatherNight = day.textNight || day.weather_night || weather;
        const humidity = day.humidity || '--';
        const uvIndex = day.uvIndex || day.uv_index || '--';
        
        html += `
          <div class="forecast-card" data-date="${date}" data-weather-day="${weather}" 
               data-weather-night="${weatherNight}" data-max="${maxTemp}" data-min="${minTemp}"
               data-humidity="${humidity}" data-uv="${uvIndex}">
            <div class="forecast-day">${index === 0 ? 'ä»Šå¤©' : date}</div>
            <div class="forecast-icon">${icon}</div>
            <div class="forecast-temp">
              <span class="max-temp">${maxTemp}Â°</span>
              <span class="min-temp">${minTemp}Â°</span>
            </div>
          </div>
        `;
      });
      
      elements.forecastContainer.innerHTML = html;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.forecast-card').forEach(card => {
        card.addEventListener('click', function() {
          const date = this.getAttribute('data-date');
          const weatherDay = this.getAttribute('data-weather-day');
          const weatherNight = this.getAttribute('data-weather-night');
          const maxTemp = this.getAttribute('data-max');
          const minTemp = this.getAttribute('data-min');
          const humidity = this.getAttribute('data-humidity');
          const uvIndex = this.getAttribute('data-uv');
          
          // æ„å»ºè¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†
          let detailHTML = `
            <div style="padding: 20px; text-align: center;">
              <h3 style="margin-bottom: 10px;">${date === 'ä»Šå¤©' ? 'ä»Šæ—¥å¤©æ°”' : date}</h3>
              
              <div style="display: flex; justify-content: space-around; margin: 15px 0;">
            <div>
                  <div style="opacity: 0.7;">ç™½å¤©</div>
                  <div style="font-size: 1.5rem; margin: 5px 0;">${getWeatherIcon(weatherDay)}</div>
                  <div>${weatherDay}</div>
            </div>
                <div>
                  <div style="opacity: 0.7;">å¤œé—´</div>
                  <div style="font-size: 1.5rem; margin: 5px 0;">${getWeatherIcon(weatherNight)}</div>
                  <div>${weatherNight}</div>
                </div>
              </div>
              
              <div style="font-size: 1.2rem; margin: 15px 0;">
                <span class="max-temp">${maxTemp}Â°</span> / 
                <span class="min-temp">${minTemp}Â°</span>
              </div>
              
              <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                ${humidity !== '--' ? `<div><span style="opacity: 0.7;">æ¹¿åº¦</span><br>${humidity}%</div>` : ''}
                ${uvIndex !== '--' ? `<div><span style="opacity: 0.7;">ç´«å¤–çº¿æŒ‡æ•°</span><br>${getUVIndexText(uvIndex)}</div>` : ''}
              </div>
        </div>
      `;
          
          showModal(detailHTML);
        });
      });
    }
    
    // è·å–ç´«å¤–çº¿æŒ‡æ•°æ–‡å­—æè¿°
    function getUVIndexText(uvIndex) {
      const index = parseInt(uvIndex);
      if (isNaN(index)) return uvIndex;
      
      if (index <= 2) return `${uvIndex} (ä½)`;
      if (index <= 5) return `${uvIndex} (ä¸­ç­‰)`;
      if (index <= 7) return `${uvIndex} (é«˜)`;
      if (index <= 10) return `${uvIndex} (å¾ˆé«˜)`;
      return `${uvIndex} (æé«˜)`;
    }
    
    // æ˜¾ç¤ºæ¨¡æ€å¯¹è¯æ¡†
    function showModal(content) {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯¹è¯æ¡†ï¼Œå¦‚æœæœ‰åˆ™ç§»é™¤
      const existingModal = document.getElementById('weather-modal');
      if (existingModal) {
        document.body.removeChild(existingModal);
      }
      
      // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
      const modal = document.createElement('div');
      modal.id = 'weather-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      `;
      
      // åˆ›å»ºæ¨¡æ€å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background-color: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        border-radius: 20px;
        width: 85%;
        max-width: 350px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
      `;
      
      // è®¾ç½®å†…å®¹
      modalContent.innerHTML = content;
      
      // æ·»åŠ å…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.textContent = 'å…³é—­';
      closeButton.className = 'btn-ios';
      closeButton.style.cssText = `
        margin: 15px auto;
        display: block;
        width: 120px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        border-radius: 24px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.5);
      `;
      
      modalContent.appendChild(closeButton);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        modal.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
      }, 10);
      
      // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–èƒŒæ™¯å…³é—­
      closeButton.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // å…³é—­æ¨¡æ€æ¡†
      function closeModal() {
        modal.style.opacity = '0';
        modalContent.style.transform = 'scale(0.9)';
        setTimeout(() => {
          document.body.removeChild(modal);
        }, 300);
      }
    }
    
    // è®¾ç½®å¤©æ°”èƒŒæ™¯å’ŒåŠ¨ç”»
    function setWeatherBackground(weather) {
      // é¦–å…ˆç§»é™¤æ‰€æœ‰å¤©æ°”ç›¸å…³ç±»
      document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'foggy');
      
      // æ¸…é™¤ç°æœ‰çš„åŠ¨ç”»å…ƒç´ 
      elements.weatherAnimationContainer.innerHTML = '';
      
      // æ ¹æ®å¤©æ°”ç±»å‹è®¾ç½®å¯¹åº”çš„èƒŒæ™¯å’ŒåŠ¨ç”»
      if (/æ™´|clear/.test(weather)) {
        document.body.classList.add('sunny');
        createSunnyAnimation();
      } else if (/å¤šäº‘|é˜´|cloud|overcast/.test(weather)) {
        document.body.classList.add('cloudy');
        createCloudyAnimation();
      } else if (/é›¨|rain|drizzle|storm/.test(weather)) {
        document.body.classList.add('rainy');
        createRainAnimation();
      } else if (/é›ª|snow|sleet/.test(weather)) {
        document.body.classList.add('snowy');
        createSnowAnimation();
      } else if (/é›¾|éœ¾|fog|haze|mist/.test(weather)) {
        document.body.classList.add('foggy');
        createFoggyAnimation();
      } else {
        // é»˜è®¤è®¾ç½®
        document.body.classList.add('sunny');
      }
    }
    
    // åˆ›å»ºæ™´å¤©åŠ¨ç”»
    function createSunnyAnimation() {
      const sun = document.createElement('div');
      sun.style.cssText = `
        position: absolute;
        top: 5%;
        right: 10%;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: radial-gradient(#FFD700, #FF8C00);
        box-shadow: 0 0 50px #FF8C00, 0 0 100px #FFD700;
        opacity: 0.8;
        animation: pulse 3s infinite alternate;
      `;
      
      elements.weatherAnimationContainer.appendChild(sun);
      
      // æ·»åŠ è„‰åŠ¨æ•ˆæœ
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse {
          0% { transform: scale(1); opacity: 0.8; }
          100% { transform: scale(1.1); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    }
    
    // åˆ›å»ºå¤šäº‘åŠ¨ç”»
    function createCloudyAnimation() {
      for (let i = 0; i < 5; i++) {
        const cloud = document.createElement('div');
        const top = Math.random() * 30;
        const left = Math.random() * 80;
        const scale = 0.5 + Math.random() * 0.5;
        const speed = 50 + Math.random() * 50;
        
        cloud.style.cssText = `
          position: absolute;
          top: ${top}%;
          left: ${left}%;
          width: 100px;
          height: 60px;
          background: rgba(255, 255, 255, 0.7);
          border-radius: 50px;
          transform: scale(${scale});
          opacity: 0.7;
          animation: float ${speed}s linear infinite;
        `;
        
        // åˆ›å»ºäº‘æœµå½¢çŠ¶
        const before = document.createElement('div');
        before.style.cssText = `
          position: absolute;
          top: -30px;
          left: 25px;
          width: 60px;
          height: 60px;
          background: rgba(255, 255, 255, 0.7);
          border-radius: 50%;
        `;
        
        const after = document.createElement('div');
        after.style.cssText = `
          position: absolute;
          top: -20px;
          left: 60px;
          width: 40px;
          height: 40px;
          background: rgba(255, 255, 255, 0.7);
          border-radius: 50%;
        `;
        
        cloud.appendChild(before);
        cloud.appendChild(after);
        elements.weatherAnimationContainer.appendChild(cloud);
      }
      
      // æ·»åŠ æµ®åŠ¨æ•ˆæœ
      const style = document.createElement('style');
      style.textContent = `
        @keyframes float {
          0% { transform: translateX(-100%) scale(var(--scale, 1)); }
          100% { transform: translateX(100vw) scale(var(--scale, 1)); }
        }
      `;
      document.head.appendChild(style);
    }
    
    // åˆ›å»ºé›¨å¤©åŠ¨ç”»
    function createRainAnimation() {
      for (let i = 0; i < 80; i++) {
        const drop = document.createElement('div');
        const left = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = 0.5 + Math.random() * 0.5;
        
        drop.className = 'rain-drop';
        drop.style.cssText = `
          left: ${left}%;
          animation-delay: ${delay}s;
          animation-duration: ${duration}s;
        `;
        
        elements.weatherAnimationContainer.appendChild(drop);
      }
    }
    
    // åˆ›å»ºé›ªå¤©åŠ¨ç”»
    function createSnowAnimation() {
      for (let i = 0; i < 50; i++) {
        const flake = document.createElement('div');
        const left = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = 5 + Math.random() * 10;
        const size = 3 + Math.random() * 5;
        
        flake.style.cssText = `
          position: absolute;
          top: -10px;
          left: ${left}%;
          width: ${size}px;
          height: ${size}px;
          background: white;
          border-radius: 50%;
          opacity: 0.8;
          animation: snowfall ${duration}s linear infinite;
          animation-delay: ${delay}s;
        `;
        
        elements.weatherAnimationContainer.appendChild(flake);
      }
      
      // æ·»åŠ é›ªèŠ±é£˜è½åŠ¨ç”»
      const style = document.createElement('style');
      style.textContent = `
        @keyframes snowfall {
          0% {
            transform: translateY(-10px) rotate(0deg);
            opacity: 0;
          }
          10% {
            opacity: 1;
          }
          90% {
            opacity: 0.8;
          }
          100% {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
    // åˆ›å»ºé›¾å¤©åŠ¨ç”»
    function createFoggyAnimation() {
      for (let i = 0; i < 5; i++) {
        const fog = document.createElement('div');
        const top = 20 + Math.random() * 60;
        
        fog.style.cssText = `
          position: absolute;
          top: ${top}%;
          left: 0;
          width: 100%;
          height: 40px;
          background: rgba(255, 255, 255, 0.3);
          filter: blur(20px);
          animation: fogDrift ${20 + Math.random() * 10}s linear infinite alternate;
        `;
        
        elements.weatherAnimationContainer.appendChild(fog);
      }
      
      // æ·»åŠ é›¾æ¼‚ç§»åŠ¨æ•ˆæœ
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fogDrift {
          0% { transform: translateX(-5%); }
          100% { transform: translateX(5%); }
        }
      `;
      document.head.appendChild(style);
    }
    
    // è·å–å¤©æ°”å›¾æ ‡
    function getWeatherIcon(weather) {
      let iconText = weatherIcons[weather] || 'ğŸŒ¤';
      
      // ä¸ºä¸åŒå¤©æ°”çŠ¶æ€æ·»åŠ é¢å¤–çš„æ ·å¼
      let iconClass = '';
      if (/æ™´|clear/.test(weather)) {
        iconClass = 'sunny-icon';
      } else if (/é›¨|rain/.test(weather)) {
        iconClass = 'rainy-icon';
      } else if (/é›ª|snow/.test(weather)) {
        iconClass = 'snowy-icon';
      } else if (/äº‘|é˜´|cloud|overcast/.test(weather)) {
        iconClass = 'cloudy-icon';
      }
      
      return `<span class="${iconClass}" style="font-size: 200%;">${iconText}</span>`;
    }
    
    // è·å–ç©ºæ°”è´¨é‡ç­‰çº§æ ·å¼
    function getAQIClass(aqi) {
      const num = parseInt(aqi);
      if (isNaN(num)) return '';
      
      if (num <= 50) return 'text-success';
      if (num <= 100) return 'text-info';
      if (num <= 150) return 'text-warning';
      return 'text-danger';
    }
    
    // è·å–ç©ºæ°”è´¨é‡æ–‡å­—æè¿°
    function getAQIText(aqi) {
      const num = parseInt(aqi);
      if (isNaN(num)) return '';
      
      if (num <= 50) return 'ä¼˜';
      if (num <= 100) return 'è‰¯';
      if (num <= 150) return 'è½»åº¦æ±¡æŸ“';
      if (num <= 200) return 'ä¸­åº¦æ±¡æŸ“';
      if (num <= 300) return 'é‡åº¦æ±¡æŸ“';
      return 'ä¸¥é‡æ±¡æŸ“';
    }
    
    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    function showLoading() {
      elements.loadingContainer.classList.add('show');
    }
    
    // éšè—åŠ è½½åŠ¨ç”»
    function hideLoading() {
      elements.loadingContainer.classList.remove('show');
    }
    
    // å¤„ç†é”™è¯¯
    function handleError(error) {
      console.error('å‘ç”Ÿé”™è¯¯:', error);
      hideLoading();
      
      // å°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®
      const cachedData = localStorage.getItem(cacheName);
      if (cachedData) {
        try {
          const parsedData = JSON.parse(cachedData);
          if (parsedData.weather) {
            updateUI(parsedData.weather);
            // æ˜¾ç¤ºæç¤ºï¼Œä½¿ç”¨çš„æ˜¯ç¼“å­˜æ•°æ®
            elements.cityName.textContent = 'ä½¿ç”¨ç¼“å­˜çš„å¤©æ°”æ•°æ®';
            elements.currentDescription.innerHTML = `è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•<br><small style="font-size:0.8rem">ä¸Šæ¬¡æ›´æ–°: ${new Date(parsedData.timestamp).toLocaleString()}</small>`;
            
            return;
          }
        } catch (e) {
          console.error('ç¼“å­˜è§£æé”™è¯¯:', e);
        }
      }
      
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      elements.cityName.textContent = 'æ— æ³•è·å–å¤©æ°”æ•°æ®';
      elements.currentDescription.textContent = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•';
      elements.currentTemp.textContent = '--';
      
      // æ·»åŠ é‡è¯•æŒ‰é’®
      const retryButton = document.createElement('button');
      retryButton.innerText = 'é‡æ–°å°è¯•';
      retryButton.className = 'btn-ios';
      retryButton.style.cssText = 'margin-top: 1rem; width: 120px; padding: 10px; font-size: 1rem; background-color: rgba(255, 255, 255, 0.3);';
      retryButton.onclick = () => {
        location.reload();
      };
      
      // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§æŒ‰é’®
      const existingButton = document.querySelector('#retry-button');
      if (existingButton) {
        existingButton.remove();
      }
      
      // æ·»åŠ IDä»¥ä¾¿äºåç»­å¼•ç”¨
      retryButton.id = 'retry-button';
      elements.currentDescription.appendChild(document.createElement('br'));
      elements.currentDescription.appendChild(retryButton);
    }
    
    // æ˜¾ç¤ºè¯Šæ–­å·¥å…·
    function showDiagnosticTools() {
      const diagnosticsArea = document.getElementById('diagnostics-area');
      diagnosticsArea.style.display = 'block';
      
      // ç»‘å®šè¯Šæ–­æŒ‰é’®äº‹ä»¶
      document.getElementById('run-diagnostics-btn').addEventListener('click', runDiagnostics);
      document.getElementById('toggle-api-btn').addEventListener('click', toggleApiSource);
      document.getElementById('clear-cache-btn').addEventListener('click', clearCache);
    }
    
    // è¿è¡Œè¯Šæ–­
    async function runDiagnostics() {
      const resultsArea = document.getElementById('diagnostics-results');
      resultsArea.style.display = 'block';
      resultsArea.innerHTML = 'æ­£åœ¨è¿è¡Œè¯Šæ–­...<br>';
      
      try {
        // æ£€æŸ¥ç½‘ç»œè¿æ¥
        resultsArea.innerHTML += `ç½‘ç»œè¿æ¥: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}<br>`;
        
        // æ£€æŸ¥ç¼“å­˜
        const hasCache = localStorage.getItem(cacheName) !== null;
        resultsArea.innerHTML += `æœ¬åœ°ç¼“å­˜: ${hasCache ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}<br>`;
        
        // æ£€æŸ¥APIæœåŠ¡å™¨é…ç½®
        resultsArea.innerHTML += `APIåŸºç¡€URL: ${window.baseUrl || '(ä½¿ç”¨ç›¸å¯¹è·¯å¾„)'}<br>`;
        
        // æµ‹è¯•ä¸åŒçš„APIç«¯ç‚¹
        const endpoints = [
          { name: 'æ ‡å‡†å¤©æ°”API', url: `${window.baseUrl}/api/weather?location=auto:ip` },
          { name: 'ç›´æ¥å¤©æ°”API', url: `${window.baseUrl}/weather?location=auto:ip` },
          { name: 'æ¨¡æ‹Ÿå¤©æ°”API', url: `${window.baseUrl}/mock-weather?location=auto:ip` }
        ];
        
        for (const endpoint of endpoints) {
          try {
            const timingStart = Date.now();
            const response = await fetchWithTimeout(endpoint.url, { timeout: 3000 });
            const pingTime = Date.now() - timingStart;
            
            if (response.ok) {
              resultsArea.innerHTML += `${endpoint.name}: å“åº”æ­£å¸¸ (${pingTime}ms)<br>`;
            } else {
              resultsArea.innerHTML += `${endpoint.name}: å“åº”é”™è¯¯ ${response.status}<br>`;
            }
          } catch (e) {
            resultsArea.innerHTML += `${endpoint.name}: ${e.message}<br>`;
          }
        }
        
        // æ£€æŸ¥æµè§ˆå™¨ä¿¡æ¯
        resultsArea.innerHTML += `æµè§ˆå™¨ä¿¡æ¯: ${navigator.userAgent}<br>`;
        
        // å½“å‰çŠ¶æ€
        resultsArea.innerHTML += `ä½¿ç”¨å¤‡ç”¨API: ${useFallbackAPI ? 'æ˜¯' : 'å¦'}<br>`;
        resultsArea.innerHTML += `å¤±è´¥å°è¯•æ¬¡æ•°: ${failedAttempts}<br>`;
        
        // æ˜¾ç¤ºè¯Šæ–­å®Œæˆå’Œå»ºè®®
        resultsArea.innerHTML += '<br><strong>è¯Šæ–­å»ºè®®:</strong><br>';
        if (!navigator.onLine) {
          resultsArea.innerHTML += '- æ‚¨å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥<br>';
        } else if (failedAttempts > 0) {
          resultsArea.innerHTML += '- å°è¯•åˆ‡æ¢API<br>';
          resultsArea.innerHTML += '- æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½<br>';
          resultsArea.innerHTML += '- æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦å—é™æˆ–ä»£ç†è®¾ç½®<br>';
        } else {
          resultsArea.innerHTML += '- æš‚æ— å¼‚å¸¸ï¼Œè¯·å°è¯•é‡æ–°åŠ è½½é¡µé¢<br>';
        }
      } catch (error) {
        resultsArea.innerHTML += `è¯Šæ–­è¿‡ç¨‹å‡ºé”™: ${error.message}<br>`;
      }
    }
    
    // åˆ‡æ¢API
    function toggleApiSource() {
      useFallbackAPI = !useFallbackAPI;
      showNotification(`å·²åˆ‡æ¢åˆ°${useFallbackAPI ? 'å¤‡ç”¨' : 'ä¸»è¦'}APIæº`, 'info');
      
      // ç›´æ¥å°è¯•ä½¿ç”¨æ–°çš„APIæºè·å–æ•°æ®
      fetchWeatherData(userCity || 'auto:ip');
    }
    
    // æ¸…é™¤ç¼“å­˜
    function clearCache() {
      localStorage.removeItem(cacheName);
      showNotification('å·²æ¸…é™¤ç¼“å­˜', 'info');
      
      // æ˜¾ç¤ºæ¸…é™¤å®Œæˆæç¤º
      const diagnosticsResults = document.getElementById('diagnostics-results');
      diagnosticsResults.style.display = 'block';
      diagnosticsResults.innerHTML = 'ç¼“å­˜å·²æ¸…é™¤ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢è·å–æ–°æ•°æ®';
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ(YYYY-MM-DD -> MMæœˆDDæ—¥)
    function formatDate(dateStr) {
      if (!dateStr) return '';
      
      try {
        const date = new Date(dateStr);
        return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
      } catch (e) {
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æœˆå’Œæ—¥
        const match = dateStr.match(/\d{4}-(\d{2})-(\d{2})/);
        if (match) {
          return `${parseInt(match[1])}æœˆ${parseInt(match[2])}æ—¥`;
        }
        return dateStr;
      }
    }
    
    // æ ¼å¼åŒ–å°æ—¶æ—¶é—´(YYYY-MM-DD HH:MM:SS -> HH:MM)
    function formatHourTime(timeStr) {
      if (!timeStr) return '';
      
      const match = timeStr.match(/(\d{2}):(\d{2})/);
      if (match) {
        return `${match[1]}:${match[2]}`;
      }
      
      // å°è¯•ä»æ—¥æœŸå­—ç¬¦ä¸²ä¸­æå–æ—¶é—´
      const dateMatch = timeStr.match(/\d{4}-\d{2}-\d{2}T(\d{2}):\d{2}/);
      if (dateMatch) {
        return `${dateMatch[1]}æ—¶`;
      }
      
      return timeStr;
    }
    
    // æ›´æ–°å½“å‰æ—¥æœŸ
    function updateCurrentDate() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      elements.currentDate.textContent = now.toLocaleDateString('zh-CN', options);
    }
    
    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // ç”Ÿæˆæ¨¡æ‹Ÿå¤©æ°”æ•°æ®ï¼ˆå½“æ‰€æœ‰APIéƒ½å¤±è´¥æ—¶ä½¿ç”¨)
    function generateMockWeatherData(location) {
      const now = new Date();
      const cityName = location !== 'auto:ip' ? location : 'å½“å‰ä½ç½®';
      
      // åˆ›å»ºä¸€äº›åˆç†çš„æ¨¡æ‹Ÿæ•°æ®
      return {
        location: {
          name: cityName,
          country: 'ä¸­å›½'
        },
        now: {
          temp: '20',
          feelsLike: '19',
          humidity: '65',
          windSpeed: '3.5',
          text: 'å¤šäº‘',
          weather: 'å¤šäº‘'
        },
        hourly: Array(24).fill().map((_, i) => {
          const hour = new Date(now);
          hour.setHours(now.getHours() + i);
          return {
            time: hour.toISOString(),
            temp: (20 + Math.sin(i/6) * 5).toFixed(0),
            text: i % 4 === 0 ? 'å¤šäº‘' : 'æ™´',
            weather: i % 4 === 0 ? 'å¤šäº‘' : 'æ™´',
            pop: (Math.random() * 30).toFixed(0)
          };
        }),
        daily: Array(7).fill().map((_, i) => {
          const day = new Date(now);
          day.setDate(now.getDate() + i);
          return {
            date: day.toISOString().split('T')[0],
            tempMax: (23 + Math.sin(i/2) * 3).toFixed(0),
            tempMin: (14 + Math.sin(i/2) * 2).toFixed(0),
            textDay: i % 3 === 0 ? 'å¤šäº‘' : i % 3 === 1 ? 'æ™´' : 'å°é›¨',
            textNight: i % 4 === 0 ? 'å¤šäº‘' : 'æ™´',
            humidity: (60 + Math.random() * 20).toFixed(0),
            uvIndex: (Math.random() * 10).toFixed(0)
          };
        }),
        air: {
          aqi: '75'
        }
      };
    }
    
    // æ·»åŠ ä¸€ä¸ªè¶…æ—¶åŠŸèƒ½çš„fetch
    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 8000 } = options;
      
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      
      try {
        const response = await fetch(resource, {
          ...options,
          signal: controller.signal  
        });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        if (error.name === 'AbortError') {
          throw new Error('è¯·æ±‚è¶…æ—¶');
        }
        throw error;
      }
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
      // ç§»é™¤ç°æœ‰é€šçŸ¥
      const existingNotice = document.getElementById('weather-notification');
      if (existingNotice) {
        document.body.removeChild(existingNotice);
      }
      
      // åˆ›å»ºé€šçŸ¥å…ƒç´ 
      const notice = document.createElement('div');
      notice.id = 'weather-notification';
      notice.style.cssText = `
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        z-index: 9999;
        font-size: 0.9rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 80%;
        text-align: center;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      `;
      
      // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
      if (type === 'warning') {
        notice.style.backgroundColor = 'rgba(255, 152, 0, 0.8)';
      } else if (type === 'error') {
        notice.style.backgroundColor = 'rgba(244, 67, 54, 0.8)';
      } else if (type === 'success') {
        notice.style.backgroundColor = 'rgba(76, 175, 80, 0.8)';
      }
      
      notice.textContent = message;
      document.body.appendChild(notice);
      
      // æ˜¾ç¤ºé€šçŸ¥
      setTimeout(() => {
        notice.style.opacity = '1';
      }, 10);
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        notice.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(notice)) {
            document.body.removeChild(notice);
          }
        }, 300);
      }, 3000);
    }
    
    // æ˜¾ç¤ºç¦»çº¿é€šçŸ¥
    function showOfflineNotice() {
      showNotification('æ‚¨å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæ˜¾ç¤ºæœ€åç¼“å­˜çš„å¤©æ°”æ•°æ®', 'warning');
      
      // æ·»åŠ ç¦»çº¿æŒ‡ç¤º
      if (!document.getElementById('offline-indicator')) {
        const indicator = document.createElement('div');
        indicator.id = 'offline-indicator';
        indicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background-color: rgba(244, 67, 54, 0.9);
          color: white;
          padding: 8px 15px;
          border-radius: 20px;
          font-size: 0.8rem;
          z-index: 999;
        `;
        indicator.textContent = 'ç¦»çº¿æ¨¡å¼';
        document.body.appendChild(indicator);
      }
    }
    
    // éšè—ç¦»çº¿é€šçŸ¥
    function hideOfflineNotice() {
      const indicator = document.getElementById('offline-indicator');
      if (indicator) {
        document.body.removeChild(indicator);
      }
      showNotification('ç½‘ç»œå·²æ¢å¤è¿æ¥', 'success');
    }

    // æ˜¾ç¤ºåŸå¸‚é€‰æ‹©å™¨
    function showCitySelector() {
      // åˆ›å»ºæ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.id = 'city-selector-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      `;
      
      // åˆ›å»ºæ¨¡æ€å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background-color: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        border-radius: 20px;
        width: 85%;
        max-width: 350px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 20px;
      `;
      
      // æ ‡é¢˜
      const title = document.createElement('h3');
      title.textContent = 'é€‰æ‹©åŸå¸‚';
      title.style.cssText = `
        text-align: center;
        margin-bottom: 15px;
      `;
      
      // æœç´¢è¾“å…¥æ¡†
      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.placeholder = 'è¾“å…¥åŸå¸‚åç§°...';
      searchInput.style.cssText = `
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 16px;
        margin-bottom: 15px;
        box-sizing: border-box;
      `;
      
      // æœç´¢ç»“æœå®¹å™¨
      const searchResults = document.createElement('div');
      searchResults.style.cssText = `
        max-height: 250px;
        overflow-y: auto;
        margin-bottom: 15px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 5px;
      `;
      
      // ç§»é™¤å¿«æ·åŸå¸‚é€‰æ‹©éƒ¨åˆ†
      
      // æ·»åŠ å½“å‰ä½ç½®æŒ‰é’®
      const locationBtn = document.createElement('button');
      locationBtn.textContent = 'ğŸ“ å½“å‰ä½ç½®';
      locationBtn.className = 'btn-ios';
      locationBtn.style.cssText = `
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 15px;
        color: white;
        cursor: pointer;
        margin-bottom: 15px;
        width: 100%;
      `;
      locationBtn.addEventListener('click', () => {
        showNotification('æ­£åœ¨è·å–ä½ç½®...', 'info');
        getUserLocation()
          .then(position => {
            if (position) {
              const { latitude, longitude } = position.coords;
              fetchWeatherData(`${longitude},${latitude}`);
              showNotification('æ­£åœ¨è·å–å½“å‰ä½ç½®å¤©æ°”...', 'info');
            } else {
              showNotification('æ— æ³•è·å–ä½ç½®ï¼Œä½¿ç”¨é»˜è®¤åŸå¸‚', 'warning');
              fetchWeatherData('101010100', 'åŒ—äº¬'); // é»˜è®¤åŒ—äº¬
            }
          })
          .catch(error => {
            console.error('ä½ç½®è·å–å¤±è´¥:', error);
            showNotification('è·å–ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åŸå¸‚', 'error');
            fetchWeatherData('101010100', 'åŒ—äº¬');
          });
        closeModal();
      });
      
      // å…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.textContent = 'å…³é—­';
      closeButton.className = 'btn-ios';
      closeButton.style.cssText = `
        width: 100%;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
      `;
      
      // ç«‹å³æœç´¢å‡½æ•°(ä¸ä½¿ç”¨é˜²æŠ–ï¼Œç›´æ¥æœç´¢)
      function searchCity(query) {
        if (query.length < 2) {
          searchResults.innerHTML = '';
          return;
        }
        
        searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">æœç´¢ä¸­...</div>';
        
        // ç›´æ¥è°ƒç”¨å’Œé£å¤©æ°”åŸå¸‚æŸ¥è¯¢API
        const apiUrl = `${window.geoUrl}/city/lookup?location=${encodeURIComponent(query)}&key=${window.qweatherKey}`;
        console.log('æœç´¢åŸå¸‚URL:', apiUrl);
        
        fetch(apiUrl)
          .then(response => {
            console.log('æœç´¢åŸå¸‚æ¥æ”¶åˆ°å“åº”:', response.status);
            if (!response.ok) {
              throw new Error(`APIè¯·æ±‚é”™è¯¯: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('åŸå¸‚æœç´¢ç»“æœ:', data);
            
            if (data.code === '200' && data.location && data.location.length > 0) {
              searchResults.innerHTML = '';
              
              data.location.slice(0, 15).forEach(city => {
                const cityItem = document.createElement('div');
                cityItem.style.cssText = `
                  padding: 12px;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                  cursor: pointer;
                  border-radius: 8px;
                  transition: background-color 0.2s;
                `;
                cityItem.innerHTML = `
                  <div style="font-weight: bold;">${city.name}</div>
                  <div style="font-size: 0.8rem; opacity: 0.8;">${city.adm2 || ''} ${city.adm1 || ''}</div>
                `;
                cityItem.addEventListener('click', () => {
                  showNotification(`æ­£åœ¨è·å–${city.name}çš„å¤©æ°”æ•°æ®...`, 'info');
                  fetchWeatherData(city.id, city.name);
                  closeModal();
                });
                cityItem.addEventListener('mouseover', () => {
                  cityItem.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                });
                cityItem.addEventListener('mouseout', () => {
                  cityItem.style.backgroundColor = 'transparent';
                });
                searchResults.appendChild(cityItem);
              });
              
              // å¦‚æœæ²¡æœ‰ç«‹å³æ˜¾ç¤ºç»“æœï¼Œæ·»åŠ æç¤º
              if (searchResults.children.length === 0) {
                searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">æœªæ‰¾åˆ°ç›¸å…³åŸå¸‚</div>';
              }
            } else {
              searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">æœªæ‰¾åˆ°ç›¸å…³åŸå¸‚</div>';
            }
          })
          .catch(error => {
            console.error('æœç´¢åŸå¸‚å¤±è´¥:', error);
            searchResults.innerHTML = '<div style="text-align: center; padding: 10px;">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
          });
      }
      
      // ç»‘å®šæœç´¢æŒ‰é’®
      const searchButton = document.createElement('button');
      searchButton.textContent = 'ğŸ” æœç´¢';
      searchButton.className = 'btn-ios';
      searchButton.style.cssText = `
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 15px;
        color: white;
        cursor: pointer;
        margin-bottom: 15px;
        width: 100%;
      `;
      searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) {
          searchCity(query);
        }
      });
      
      // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = searchInput.value.trim();
          if (query) {
            searchCity(query);
          }
        }
      });
      
      // ç»„è£…æ¨¡æ€æ¡†
      modalContent.appendChild(title);
      modalContent.appendChild(searchInput);
      modalContent.appendChild(searchButton);
      modalContent.appendChild(searchResults);
      modalContent.appendChild(locationBtn);
      modalContent.appendChild(closeButton);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶èšç„¦æœç´¢æ¡†
      setTimeout(() => {
        modal.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
        searchInput.focus();
      }, 10);
      
      // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–èƒŒæ™¯å…³é—­
      closeButton.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // å…³é—­æ¨¡æ€æ¡†
      function closeModal() {
        modal.style.opacity = '0';
        modalContent.style.transform = 'scale(0.9)';
        setTimeout(() => {
          document.body.removeChild(modal);
        }, 300);
      }
    }
  </script>
</body>
</html>

